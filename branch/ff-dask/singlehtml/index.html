<!doctype html>
<html class="no-js" lang="en" data-content_root="./">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="genindex.html"><link rel="search" title="Search" href="search.html">
        <link rel="prefetch" href="_static/ENCCS_logo_light.png" as="image">
        <link rel="prefetch" href="_static/ENCCS_logo_dark.png" as="image">

    <link rel="shortcut icon" href="_static/favicon.ico"><!-- Generated with Sphinx 8.2.3 and Furo 2025.09.25 -->
        <title>Python for High Performance Data Analytics</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=580074bf" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx_lesson.css?v=0c089442" />
    <link rel="stylesheet" type="text/css" href="_static/term_role_formatting.css?v=4194e21c" />
    <link rel="stylesheet" type="text/css" href="_static/furo_ext_lesson.css?v=685c8e98" />
    <link rel="stylesheet" type="text/css" href="_static/tabs.css?v=a5c4661c" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=8dab3a3b" />
    <link rel="stylesheet" type="text/css" href="_static/overrides.css?v=1c72d2de" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="#"><div class="brand">Python for High Performance Data Analytics</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="#">
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="_static/ENCCS_logo_light.png" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="_static/ENCCS_logo_dark.png" alt="Dark Logo"/>
  </div>
  
  <span class="sidebar-brand-text">Python for High Performance Data Analytics</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">The lesson</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="#document-tabular-data">Tabular data (aka Dataframes)</a></li>
<li class="toctree-l1"><a class="reference internal" href="#document-interfacing-with-storage">Storage &amp; serialisation backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="#document-visualisation">Visualisations and dashboards</a></li>
<li class="toctree-l1"><a class="reference internal" href="#document-benchmarking">Benchmarking</a></li>
<li class="toctree-l1"><a class="reference internal" href="#document-multithreading">Multithreading</a></li>
<li class="toctree-l1"><a class="reference internal" href="#document-dask">Dask for Scalable Analytics</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Optional material</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="#document-dask_opt">Dask (II)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="#document-quick-reference">Quick Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="#document-guide">Instructor’s guide</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="python-for-high-performance-data-analytics">
<h1>Python for High Performance Data Analytics<a class="headerlink" href="#python-for-high-performance-data-analytics" title="Link to this heading">¶</a></h1>
<div class="admonition-prerequisites prerequisites admonition" id="prerequisites-0">
<p class="admonition-title">Prerequisites</p>
<ul class="simple">
<li><p>Basic proficiency in Python (variables, flow control, functions)</p></li>
<li><p>Basic grasp of descriptive statistics (such as minimum, maximum, median, arithmetic mean…)</p></li>
<li><p>Basic knowledge of NumPy</p></li>
<li><p>Basic knowledge of some plotting package (Matplotlib, Seaborn, Holoviz…)</p></li>
</ul>
</div>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>20 min</p></td>
<td><p><span class="xref std std-doc">filename</span></p></td>
</tr>
</tbody>
</table>
</div>
<div class="toctree-wrapper compound">
<span id="document-tabular-data"></span><section id="tabular-data-aka-dataframes">
<h2>Tabular data (aka Dataframes)<a class="headerlink" href="#tabular-data-aka-dataframes" title="Link to this heading">¶</a></h2>
<div class="admonition-questions questions admonition" id="questions-0">
<p class="admonition-title">Questions</p>
<ul class="simple">
<li><p>What are series and dataframes?</p></li>
<li><p>What do we mean by tidy and untidy data?</p></li>
<li><p>What packages are available in Python to handle dataframes?</p></li>
</ul>
</div>
<div class="admonition-objectives objectives admonition" id="objectives-0">
<p class="admonition-title">Objectives</p>
<ul class="simple">
<li><p>Learn how to manipulate dataframes in Pandas</p></li>
<li><p>Lazy and eager dataframes in Polars</p></li>
</ul>
</div>
<p>This episode will give an introduction to the concepts of <em>Series</em> and <em>DataFrame</em>
and how they can be manipulated using different Python packages.</p>
<section id="series-and-dataframes">
<h3>Series and dataframes<a class="headerlink" href="#series-and-dataframes" title="Link to this heading">¶</a></h3>
<p>A collection of observations (e.g. a time series or simply a set of observations
of a feature of a phenomenon) can be represented by a homogeneous vector, i.e.
an array where all the elements are of the same type. This is known as a <em>Series</em>
in many frameworks. Several series (of different types) can be used as columns of
a tabular structure called a <em>Dataframe</em>, as depicted in the figure below.</p>
<p><img alt="Structure of dataframe" src="_images/01_table_dataframe.svg" /></p>
<section id="tidy-vs-untidy-dataframes">
<h4>Tidy vs untidy dataframes<a class="headerlink" href="#tidy-vs-untidy-dataframes" title="Link to this heading">¶</a></h4>
<p>Let us look at the following two dataframes:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-VW50aWR5IGZvcm1hdA==" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-0-VW50aWR5IGZvcm1hdA==" name="VW50aWR5IGZvcm1hdA==" role="tab" tabindex="0">Untidy format</button><button aria-controls="panel-0-VGlkeSBmb3JtYXQ=" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-VGlkeSBmb3JtYXQ=" name="VGlkeSBmb3JtYXQ=" role="tab" tabindex="-1">Tidy format</button></div><div aria-labelledby="tab-0-VW50aWR5IGZvcm1hdA==" class="sphinx-tabs-panel group-tab" id="panel-0-VW50aWR5IGZvcm1hdA==" name="VW50aWR5IGZvcm1hdA==" role="tabpanel" tabindex="0"><div class="table-wrapper docutils container">
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p class="rubric" id="id1"></p>
</td>
<td><p>Runner</p></td>
<td><p>400</p></td>
<td><p>800</p></td>
<td><p>1200</p></td>
<td><p>1500</p></td>
</tr>
<tr class="row-even"><td><p>0</p></td>
<td><p>Runner 1</p></td>
<td><p>64</p></td>
<td><p>128</p></td>
<td><p>192</p></td>
<td><p>240</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>Runner 2</p></td>
<td><p>80</p></td>
<td><p>160</p></td>
<td><p>240</p></td>
<td><p>300</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>Runner 3</p></td>
<td><p>96</p></td>
<td><p>192</p></td>
<td><p>288</p></td>
<td><p>360</p></td>
</tr>
</tbody>
</table>
</div>
</div><div aria-labelledby="tab-0-VGlkeSBmb3JtYXQ=" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-VGlkeSBmb3JtYXQ=" name="VGlkeSBmb3JtYXQ=" role="tabpanel" tabindex="0"><div class="table-wrapper docutils container">
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p class="rubric" id="id2"></p>
</td>
<td><p>Runner</p></td>
<td><p>distance</p></td>
<td><p>time</p></td>
</tr>
<tr class="row-even"><td><p>0</p></td>
<td><p>Runner 1</p></td>
<td><p>400</p></td>
<td><p>64</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>Runner 2</p></td>
<td><p>400</p></td>
<td><p>80</p></td>
</tr>
<tr class="row-even"><td><p>2</p></td>
<td><p>Runner 3</p></td>
<td><p>400</p></td>
<td><p>96</p></td>
</tr>
<tr class="row-odd"><td><p>3</p></td>
<td><p>Runner 1</p></td>
<td><p>800</p></td>
<td><p>128</p></td>
</tr>
<tr class="row-even"><td><p>4</p></td>
<td><p>Runner 2</p></td>
<td><p>800</p></td>
<td><p>160</p></td>
</tr>
<tr class="row-odd"><td><p>5</p></td>
<td><p>Runner 3</p></td>
<td><p>800</p></td>
<td><p>192</p></td>
</tr>
<tr class="row-even"><td><p>6</p></td>
<td><p>Runner 1</p></td>
<td><p>1200</p></td>
<td><p>192</p></td>
</tr>
<tr class="row-odd"><td><p>7</p></td>
<td><p>Runner 2</p></td>
<td><p>1200</p></td>
<td><p>240</p></td>
</tr>
<tr class="row-even"><td><p>8</p></td>
<td><p>Runner 3</p></td>
<td><p>1200</p></td>
<td><p>288</p></td>
</tr>
<tr class="row-odd"><td><p>9</p></td>
<td><p>Runner 1</p></td>
<td><p>1500</p></td>
<td><p>240</p></td>
</tr>
<tr class="row-even"><td><p>10</p></td>
<td><p>Runner 2</p></td>
<td><p>1500</p></td>
<td><p>300</p></td>
</tr>
<tr class="row-odd"><td><p>11</p></td>
<td><p>Runner 3</p></td>
<td><p>1500</p></td>
<td><p>360</p></td>
</tr>
</tbody>
</table>
</div>
</div></div>
<p>Most tabular data is either in a tidy format or a untidy format (some people
refer them as the long format or the wide format). The main differences are
summarised below:</p>
<ul class="simple">
<li><p>In untidy (wide) format, each row represents an observation consisting of
multiple variables and each variable has its own column. This is intuitive and
easy for us to understand and make comparisons across different variables,
calculate statistics, etc.</p></li>
<li><p>In tidy (long) format , i.e. column-oriented format, each row represents only
one variable of the observation, and can be considered “computer readable”.
When it comes to data analysis using Pandas, the tidy format is recommended:</p></li>
<li><p>Each column can be stored as a vector and this not only saves memory but also
allows for vectorized calculations which are much faster.</p></li>
<li><p>It’s easier to filter, group, join and aggregate the data.</p></li>
</ul>
<p>Imagine, for example, that you would like to compute the speed as
<code class="docutils literal notranslate"><span class="pre">speed=distance/time</span></code>. The untidy format would make this much clunkier, as:</p>
<ul class="simple">
<li><p>The distances are encoded as column names, not as data points (rows)</p></li>
<li><p>The speed would have to be stored in a new dataframe since it would not
fit in that data structure.</p></li>
</ul>
<p>In comparison, in a tidy dataframe, this computation would be a simple
operation between two columns.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Recovering a wide dataframe from a tidy one is commonly referred to as
<em>pivoting</em>. Most dataframe libraries provide a <code class="docutils literal notranslate"><span class="pre">pivot()</span></code> or
<code class="docutils literal notranslate"><span class="pre">pivot_table</span></code> function.</p>
</div>
</section>
</section>
<section id="pandas-polars">
<h3>Pandas &amp; Polars<a class="headerlink" href="#pandas-polars" title="Link to this heading">¶</a></h3>
<p>Historically, <a class="reference external" href="https://pandas.pydata.org/">Pandas</a> has been the go-to package
to handle dataframes in Python. It is based on NumPy (each column is a Numpy
vector) and has been the traditional workhorse for tabular data, with a stable
API and a large ecosystem built around it, including the <a class="reference external" href="https://seaborn.pydata.org/">Seaborn</a>
statistical plotting framework.
More recently, <a class="reference external" href="https://docs.pola.rs/">Polars</a> was introduced as a more modern
and faster alternative to handle dataframes. It is written in Rust and supports
out of the box out of core evaluation (i.e. does not need loading the whole
dataset in memory), lazy evaluation of queries and automatically uses multiple
threads. Moreover, experimental GPU support is available through
<a class="reference external" href="https://docs.rapids.ai/api/cudf/stable/">cuDF</a>. In the remainder of this
episode, the <a class="reference external" href="https://www.nyc.gov/site/tlc/about/tlc-trip-record-data.page">NYC taxi</a>
will be used to showcase how datasets can be accessed, summarised and manipulated
in both Pandas and Polars. The dataset can be download in <a class="reference external" href="https://parquet.apache.org/">Parquet</a>
format from the link above (the file for the month of January was used in this
case). The dataset contains information about taxi trips performed in New York,
such as the ID of the vendor, the total fare, pickup and drop-off time and
location (expressed as an ID), type of payment, whether additional fees were
charged and more.</p>
<section id="opening-a-dataset">
<h4>Opening a dataset<a class="headerlink" href="#opening-a-dataset" title="Link to this heading">¶</a></h4>
<p>Assuming the file is called <code class="docutils literal notranslate"><span class="pre">yellow_tripdata_2025-01.parquet</span></code>, the dataset can be
opened as:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-UGFuZGFz" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-1-UGFuZGFz" name="UGFuZGFz" role="tab" tabindex="0">Pandas</button><button aria-controls="panel-1-UG9sYXJz" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-1-UG9sYXJz" name="UG9sYXJz" role="tab" tabindex="-1">Polars</button></div><div aria-labelledby="tab-1-UGFuZGFz" class="sphinx-tabs-panel group-tab" id="panel-1-UGFuZGFz" name="UGFuZGFz" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span> 
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s2">&quot;yellow_tripdata_2025-01.parquet&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-1-UG9sYXJz" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-1-UG9sYXJz" name="UG9sYXJz" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span> 
<span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s2">&quot;yellow_tripdata_2025-01.parquet&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
</section>
<section id="description-and-summarisation">
<h4>Description and summarisation<a class="headerlink" href="#description-and-summarisation" title="Link to this heading">¶</a></h4>
<p>We can get a first understanding of the contents of a dataframe by printing
the first few lines, the “schema” (i.e. the number and type of each column)
and summary statistics as follows:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-2-UGFuZGFz" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-2-UGFuZGFz" name="UGFuZGFz" role="tab" tabindex="0">Pandas</button><button aria-controls="panel-2-UG9sYXJz" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-2-UG9sYXJz" name="UG9sYXJz" role="tab" tabindex="-1">Polars</button></div><div aria-labelledby="tab-2-UGFuZGFz" class="sphinx-tabs-panel group-tab" id="panel-2-UGFuZGFz" name="UGFuZGFz" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="dropdown exercise important admonition" id="exercise-0">
<p class="admonition-title">Output</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>   <span class="n">VendorID</span> <span class="n">tpep_pickup_datetime</span> <span class="n">tpep_dropoff_datetime</span>  <span class="o">...</span>  <span class="n">congestion_surcharge</span>  <span class="n">Airport_fee</span>  <span class="n">cbd_congestion_fee</span>
<span class="mi">0</span>         <span class="mi">1</span>  <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">38</span>   <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">26</span><span class="p">:</span><span class="mi">59</span>  <span class="o">...</span>                   <span class="mf">2.5</span>          <span class="mf">0.0</span>                 <span class="mf">0.0</span>
<span class="mi">1</span>         <span class="mi">1</span>  <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">40</span>   <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">13</span>  <span class="o">...</span>                   <span class="mf">2.5</span>          <span class="mf">0.0</span>                 <span class="mf">0.0</span>
<span class="mi">2</span>         <span class="mi">1</span>  <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">44</span><span class="p">:</span><span class="mi">04</span>   <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mi">01</span>  <span class="o">...</span>                   <span class="mf">2.5</span>          <span class="mf">0.0</span>                 <span class="mf">0.0</span>
<span class="mi">3</span>         <span class="mi">2</span>  <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">27</span>   <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mi">01</span>  <span class="o">...</span>                   <span class="mf">0.0</span>          <span class="mf">0.0</span>                 <span class="mf">0.0</span>
<span class="mi">4</span>         <span class="mi">2</span>  <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mi">34</span>   <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mi">06</span>  <span class="o">...</span>                   <span class="mf">0.0</span>          <span class="mf">0.0</span>                 <span class="mf">0.0</span>
</pre></div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
<div class="dropdown exercise important admonition" id="exercise-1">
<p class="admonition-title">Output</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RangeIndex</span><span class="p">:</span> <span class="mi">3475226</span> <span class="n">entries</span><span class="p">,</span> <span class="mi">0</span> <span class="n">to</span> <span class="mi">3475225</span>
<span class="n">Data</span> <span class="n">columns</span> <span class="p">(</span><span class="n">total</span> <span class="mi">20</span> <span class="n">columns</span><span class="p">):</span>
 <span class="c1">#   Column                 Dtype</span>
<span class="o">---</span>  <span class="o">------</span>                 <span class="o">-----</span>
 <span class="mi">0</span>   <span class="n">VendorID</span>               <span class="n">int32</span>
 <span class="mi">1</span>   <span class="n">tpep_pickup_datetime</span>   <span class="n">datetime64</span><span class="p">[</span><span class="n">us</span><span class="p">]</span>
 <span class="mi">2</span>   <span class="n">tpep_dropoff_datetime</span>  <span class="n">datetime64</span><span class="p">[</span><span class="n">us</span><span class="p">]</span>
 <span class="mi">3</span>   <span class="n">passenger_count</span>        <span class="n">float64</span>
 <span class="mi">4</span>   <span class="n">trip_distance</span>          <span class="n">float64</span>
 <span class="mi">5</span>   <span class="n">RatecodeID</span>             <span class="n">float64</span>
 <span class="mi">6</span>   <span class="n">store_and_fwd_flag</span>     <span class="nb">object</span>
 <span class="mi">7</span>   <span class="n">PULocationID</span>           <span class="n">int32</span>
 <span class="mi">8</span>   <span class="n">DOLocationID</span>           <span class="n">int32</span>
 <span class="mi">9</span>   <span class="n">payment_type</span>           <span class="n">int64</span>
 <span class="mi">10</span>  <span class="n">fare_amount</span>            <span class="n">float64</span>
 <span class="mi">11</span>  <span class="n">extra</span>                  <span class="n">float64</span>
 <span class="mi">12</span>  <span class="n">mta_tax</span>                <span class="n">float64</span>
 <span class="mi">13</span>  <span class="n">tip_amount</span>             <span class="n">float64</span>
 <span class="mi">14</span>  <span class="n">tolls_amount</span>           <span class="n">float64</span>
 <span class="mi">15</span>  <span class="n">improvement_surcharge</span>  <span class="n">float64</span>
 <span class="mi">16</span>  <span class="n">total_amount</span>           <span class="n">float64</span>
 <span class="mi">17</span>  <span class="n">congestion_surcharge</span>   <span class="n">float64</span>
 <span class="mi">18</span>  <span class="n">Airport_fee</span>            <span class="n">float64</span>
 <span class="mi">19</span>  <span class="n">cbd_congestion_fee</span>     <span class="n">float64</span>
<span class="n">dtypes</span><span class="p">:</span> <span class="n">datetime64</span><span class="p">[</span><span class="n">us</span><span class="p">](</span><span class="mi">2</span><span class="p">),</span> <span class="n">float64</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="n">int32</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">int64</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="nb">object</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">memory</span> <span class="n">usage</span><span class="p">:</span> <span class="mf">490.5</span><span class="o">+</span> <span class="n">MB</span>
</pre></div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
<div class="dropdown exercise important admonition" id="exercise-2">
<p class="admonition-title">Output</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>           <span class="n">VendorID</span>        <span class="n">tpep_pickup_datetime</span>       <span class="n">tpep_dropoff_datetime</span>  <span class="o">...</span>  <span class="n">congestion_surcharge</span>   <span class="n">Airport_fee</span>  <span class="n">cbd_congestion_fee</span>
<span class="n">count</span>  <span class="mf">3.475226e+06</span>                     <span class="mi">3475226</span>                     <span class="mi">3475226</span>  <span class="o">...</span>          <span class="mf">2.935077e+06</span>  <span class="mf">2.935077e+06</span>        <span class="mf">3.475226e+06</span>
<span class="n">mean</span>   <span class="mf">1.785428e+00</span>  <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">17</span> <span class="mi">11</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mf">55.910964</span>  <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">17</span> <span class="mi">11</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mf">56.997901</span>  <span class="o">...</span>          <span class="mf">2.225237e+00</span>  <span class="mf">1.239111e-01</span>        <span class="mf">4.834093e-01</span>
<span class="nb">min</span>    <span class="mf">1.000000e+00</span>         <span class="mi">2024</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span> <span class="mi">20</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mi">55</span>         <span class="mi">2024</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">18</span> <span class="mi">07</span><span class="p">:</span><span class="mi">52</span><span class="p">:</span><span class="mi">40</span>  <span class="o">...</span>         <span class="o">-</span><span class="mf">2.500000e+00</span> <span class="o">-</span><span class="mf">1.750000e+00</span>       <span class="o">-</span><span class="mf">7.500000e-01</span>
<span class="mi">25</span><span class="o">%</span>    <span class="mf">2.000000e+00</span>         <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">10</span> <span class="mi">07</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">01</span>  <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">10</span> <span class="mi">08</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mf">29.500000</span>  <span class="o">...</span>          <span class="mf">2.500000e+00</span>  <span class="mf">0.000000e+00</span>        <span class="mf">0.000000e+00</span>
<span class="mi">50</span><span class="o">%</span>    <span class="mf">2.000000e+00</span>         <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">17</span> <span class="mi">15</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">33</span>         <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">17</span> <span class="mi">15</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">34</span>  <span class="o">...</span>          <span class="mf">2.500000e+00</span>  <span class="mf">0.000000e+00</span>        <span class="mf">7.500000e-01</span>
<span class="mi">75</span><span class="o">%</span>    <span class="mf">2.000000e+00</span>         <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">24</span> <span class="mi">19</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">06</span>         <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">24</span> <span class="mi">19</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mi">31</span>  <span class="o">...</span>          <span class="mf">2.500000e+00</span>  <span class="mf">0.000000e+00</span>        <span class="mf">7.500000e-01</span>
<span class="nb">max</span>    <span class="mf">7.000000e+00</span>         <span class="mi">2025</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">44</span>         <span class="mi">2025</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">01</span> <span class="mi">23</span><span class="p">:</span><span class="mi">44</span><span class="p">:</span><span class="mi">11</span>  <span class="o">...</span>          <span class="mf">2.500000e+00</span>  <span class="mf">6.750000e+00</span>        <span class="mf">7.500000e-01</span>
<span class="n">std</span>    <span class="mf">4.263282e-01</span>                         <span class="n">NaN</span>                         <span class="n">NaN</span>  <span class="o">...</span>          <span class="mf">9.039932e-01</span>  <span class="mf">4.725090e-01</span>        <span class="mf">3.619307e-01</span>

<span class="p">[</span><span class="mi">8</span> <span class="n">rows</span> <span class="n">x</span> <span class="mi">19</span> <span class="n">columns</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div><div aria-labelledby="tab-2-UG9sYXJz" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-2-UG9sYXJz" name="UG9sYXJz" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
<div class="dropdown exercise important admonition" id="exercise-3">
<p class="admonition-title">Output</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="err">┌──────────┬──────────────────┬──────────────────┬─────────────────┬───┬──────────────┬──────────────────┬─────────────┬─────────────────┐</span>
<span class="err">│</span> <span class="n">VendorID</span> <span class="err">┆</span> <span class="n">tpep_pickup_date</span> <span class="err">┆</span> <span class="n">tpep_dropoff_dat</span> <span class="err">┆</span> <span class="n">passenger_count</span> <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="n">total_amount</span> <span class="err">┆</span> <span class="n">congestion_surch</span> <span class="err">┆</span> <span class="n">Airport_fee</span> <span class="err">┆</span> <span class="n">cbd_congestion_</span> <span class="err">│</span>
<span class="err">│</span> <span class="o">---</span>      <span class="err">┆</span> <span class="n">time</span>             <span class="err">┆</span> <span class="n">etime</span>            <span class="err">┆</span> <span class="o">---</span>             <span class="err">┆</span>   <span class="err">┆</span> <span class="o">---</span>          <span class="err">┆</span> <span class="n">arge</span>             <span class="err">┆</span> <span class="o">---</span>         <span class="err">┆</span> <span class="n">fee</span>             <span class="err">│</span>
<span class="err">│</span> <span class="n">i32</span>      <span class="err">┆</span> <span class="o">---</span>              <span class="err">┆</span> <span class="o">---</span>              <span class="err">┆</span> <span class="n">i64</span>             <span class="err">┆</span>   <span class="err">┆</span> <span class="n">f64</span>          <span class="err">┆</span> <span class="o">---</span>              <span class="err">┆</span> <span class="n">f64</span>         <span class="err">┆</span> <span class="o">---</span>             <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="n">datetime</span><span class="p">[</span><span class="n">μs</span><span class="p">]</span>     <span class="err">┆</span> <span class="n">datetime</span><span class="p">[</span><span class="n">μs</span><span class="p">]</span>     <span class="err">┆</span>                 <span class="err">┆</span>   <span class="err">┆</span>              <span class="err">┆</span> <span class="n">f64</span>              <span class="err">┆</span>             <span class="err">┆</span> <span class="n">f64</span>             <span class="err">│</span>
<span class="err">╞══════════╪══════════════════╪══════════════════╪═════════════════╪═══╪══════════════╪══════════════════╪═════════════╪═════════════════╡</span>
<span class="err">│</span> <span class="mi">1</span>        <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span>       <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span>       <span class="err">┆</span> <span class="mi">1</span>               <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="mf">18.0</span>         <span class="err">┆</span> <span class="mf">2.5</span>              <span class="err">┆</span> <span class="mf">0.0</span>         <span class="err">┆</span> <span class="mf">0.0</span>             <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">38</span>         <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">26</span><span class="p">:</span><span class="mi">59</span>         <span class="err">┆</span>                 <span class="err">┆</span>   <span class="err">┆</span>              <span class="err">┆</span>                  <span class="err">┆</span>             <span class="err">┆</span>                 <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span>        <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span>       <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span>       <span class="err">┆</span> <span class="mi">1</span>               <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="mf">12.12</span>        <span class="err">┆</span> <span class="mf">2.5</span>              <span class="err">┆</span> <span class="mf">0.0</span>         <span class="err">┆</span> <span class="mf">0.0</span>             <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">40</span>         <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">13</span>         <span class="err">┆</span>                 <span class="err">┆</span>   <span class="err">┆</span>              <span class="err">┆</span>                  <span class="err">┆</span>             <span class="err">┆</span>                 <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span>        <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span>       <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span>       <span class="err">┆</span> <span class="mi">1</span>               <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="mf">12.1</span>         <span class="err">┆</span> <span class="mf">2.5</span>              <span class="err">┆</span> <span class="mf">0.0</span>         <span class="err">┆</span> <span class="mf">0.0</span>             <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">44</span><span class="p">:</span><span class="mi">04</span>         <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mi">01</span>         <span class="err">┆</span>                 <span class="err">┆</span>   <span class="err">┆</span>              <span class="err">┆</span>                  <span class="err">┆</span>             <span class="err">┆</span>                 <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span>        <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span>       <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span>       <span class="err">┆</span> <span class="mi">3</span>               <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="mf">9.7</span>          <span class="err">┆</span> <span class="mf">0.0</span>              <span class="err">┆</span> <span class="mf">0.0</span>         <span class="err">┆</span> <span class="mf">0.0</span>             <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">27</span>         <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mi">01</span>         <span class="err">┆</span>                 <span class="err">┆</span>   <span class="err">┆</span>              <span class="err">┆</span>                  <span class="err">┆</span>             <span class="err">┆</span>                 <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span>        <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span>       <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span>       <span class="err">┆</span> <span class="mi">3</span>               <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="mf">8.3</span>          <span class="err">┆</span> <span class="mf">0.0</span>              <span class="err">┆</span> <span class="mf">0.0</span>         <span class="err">┆</span> <span class="mf">0.0</span>             <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mi">34</span>         <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mi">06</span>         <span class="err">┆</span>                 <span class="err">┆</span>   <span class="err">┆</span>              <span class="err">┆</span>                  <span class="err">┆</span>             <span class="err">┆</span>                 <span class="err">│</span>
<span class="err">└──────────┴──────────────────┴──────────────────┴─────────────────┴───┴──────────────┴──────────────────┴─────────────┴─────────────────┘</span>
</pre></div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
<div class="dropdown exercise important admonition" id="exercise-4">
<p class="admonition-title">Output</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">21</span><span class="p">)</span>
<span class="err">┌────────────┬────────────┬──────────────────┬─────────────────┬───┬──────────────┬─────────────────┬─────────────┬─────────────────┐</span>
<span class="err">│</span> <span class="n">statistic</span>  <span class="err">┆</span> <span class="n">VendorID</span>   <span class="err">┆</span> <span class="n">tpep_pickup_date</span> <span class="err">┆</span> <span class="n">tpep_dropoff_da</span> <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="n">total_amount</span> <span class="err">┆</span> <span class="n">congestion_surc</span> <span class="err">┆</span> <span class="n">Airport_fee</span> <span class="err">┆</span> <span class="n">cbd_congestion_</span> <span class="err">│</span>
<span class="err">│</span> <span class="o">---</span>        <span class="err">┆</span> <span class="o">---</span>        <span class="err">┆</span> <span class="n">time</span>             <span class="err">┆</span> <span class="n">tetime</span>          <span class="err">┆</span>   <span class="err">┆</span> <span class="o">---</span>          <span class="err">┆</span> <span class="n">harge</span>           <span class="err">┆</span> <span class="o">---</span>         <span class="err">┆</span> <span class="n">fee</span>             <span class="err">│</span>
<span class="err">│</span> <span class="nb">str</span>        <span class="err">┆</span> <span class="n">f64</span>        <span class="err">┆</span> <span class="o">---</span>              <span class="err">┆</span> <span class="o">---</span>             <span class="err">┆</span>   <span class="err">┆</span> <span class="n">f64</span>          <span class="err">┆</span> <span class="o">---</span>             <span class="err">┆</span> <span class="n">f64</span>         <span class="err">┆</span> <span class="o">---</span>             <span class="err">│</span>
<span class="err">│</span>            <span class="err">┆</span>            <span class="err">┆</span> <span class="nb">str</span>              <span class="err">┆</span> <span class="nb">str</span>             <span class="err">┆</span>   <span class="err">┆</span>              <span class="err">┆</span> <span class="n">f64</span>             <span class="err">┆</span>             <span class="err">┆</span> <span class="n">f64</span>             <span class="err">│</span>
<span class="err">╞════════════╪════════════╪══════════════════╪═════════════════╪═══╪══════════════╪═════════════════╪═════════════╪═════════════════╡</span>
<span class="err">│</span> <span class="n">count</span>      <span class="err">┆</span> <span class="mf">3.475226e6</span> <span class="err">┆</span> <span class="mi">3475226</span>          <span class="err">┆</span> <span class="mi">3475226</span>         <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="mf">3.475226e6</span>   <span class="err">┆</span> <span class="mf">2.935077e6</span>      <span class="err">┆</span> <span class="mf">2.935077e6</span>  <span class="err">┆</span> <span class="mf">3.475226e6</span>      <span class="err">│</span>
<span class="err">│</span> <span class="n">null_count</span> <span class="err">┆</span> <span class="mf">0.0</span>        <span class="err">┆</span> <span class="mi">0</span>                <span class="err">┆</span> <span class="mi">0</span>               <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="mf">0.0</span>          <span class="err">┆</span> <span class="mf">540149.0</span>        <span class="err">┆</span> <span class="mf">540149.0</span>    <span class="err">┆</span> <span class="mf">0.0</span>             <span class="err">│</span>
<span class="err">│</span> <span class="n">mean</span>       <span class="err">┆</span> <span class="mf">1.785428</span>   <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">17</span>       <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">17</span>      <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="mf">25.611292</span>    <span class="err">┆</span> <span class="mf">2.225237</span>        <span class="err">┆</span> <span class="mf">0.123911</span>    <span class="err">┆</span> <span class="mf">0.483409</span>        <span class="err">│</span>
<span class="err">│</span>            <span class="err">┆</span>            <span class="err">┆</span> <span class="mi">11</span><span class="p">:</span><span class="mi">02</span><span class="p">:</span><span class="mf">55.910964</span>  <span class="err">┆</span> <span class="mi">11</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mf">56.997901</span> <span class="err">┆</span>   <span class="err">┆</span>              <span class="err">┆</span>                 <span class="err">┆</span>             <span class="err">┆</span>                 <span class="err">│</span>
<span class="err">│</span> <span class="n">std</span>        <span class="err">┆</span> <span class="mf">0.426328</span>   <span class="err">┆</span> <span class="n">null</span>             <span class="err">┆</span> <span class="n">null</span>            <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="mf">463.658478</span>   <span class="err">┆</span> <span class="mf">0.903993</span>        <span class="err">┆</span> <span class="mf">0.472509</span>    <span class="err">┆</span> <span class="mf">0.361931</span>        <span class="err">│</span>
<span class="err">│</span> <span class="nb">min</span>        <span class="err">┆</span> <span class="mf">1.0</span>        <span class="err">┆</span> <span class="mi">2024</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">31</span>       <span class="err">┆</span> <span class="mi">2024</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">18</span>      <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="o">-</span><span class="mf">901.0</span>       <span class="err">┆</span> <span class="o">-</span><span class="mf">2.5</span>            <span class="err">┆</span> <span class="o">-</span><span class="mf">1.75</span>       <span class="err">┆</span> <span class="o">-</span><span class="mf">0.75</span>           <span class="err">│</span>
<span class="err">│</span>            <span class="err">┆</span>            <span class="err">┆</span> <span class="mi">20</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mi">55</span>         <span class="err">┆</span> <span class="mi">07</span><span class="p">:</span><span class="mi">52</span><span class="p">:</span><span class="mi">40</span>        <span class="err">┆</span>   <span class="err">┆</span>              <span class="err">┆</span>                 <span class="err">┆</span>             <span class="err">┆</span>                 <span class="err">│</span>
<span class="err">│</span> <span class="mi">25</span><span class="o">%</span>        <span class="err">┆</span> <span class="mf">2.0</span>        <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">10</span>       <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">10</span>      <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="mf">15.2</span>         <span class="err">┆</span> <span class="mf">2.5</span>             <span class="err">┆</span> <span class="mf">0.0</span>         <span class="err">┆</span> <span class="mf">0.0</span>             <span class="err">│</span>
<span class="err">│</span>            <span class="err">┆</span>            <span class="err">┆</span> <span class="mi">07</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">01</span>         <span class="err">┆</span> <span class="mi">08</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">29</span>        <span class="err">┆</span>   <span class="err">┆</span>              <span class="err">┆</span>                 <span class="err">┆</span>             <span class="err">┆</span>                 <span class="err">│</span>
<span class="err">│</span> <span class="mi">50</span><span class="o">%</span>        <span class="err">┆</span> <span class="mf">2.0</span>        <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">17</span>       <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">17</span>      <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="mf">19.95</span>        <span class="err">┆</span> <span class="mf">2.5</span>             <span class="err">┆</span> <span class="mf">0.0</span>         <span class="err">┆</span> <span class="mf">0.75</span>            <span class="err">│</span>
<span class="err">│</span>            <span class="err">┆</span>            <span class="err">┆</span> <span class="mi">15</span><span class="p">:</span><span class="mi">41</span><span class="p">:</span><span class="mi">34</span>         <span class="err">┆</span> <span class="mi">15</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">34</span>        <span class="err">┆</span>   <span class="err">┆</span>              <span class="err">┆</span>                 <span class="err">┆</span>             <span class="err">┆</span>                 <span class="err">│</span>
<span class="err">│</span> <span class="mi">75</span><span class="o">%</span>        <span class="err">┆</span> <span class="mf">2.0</span>        <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">24</span>       <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">24</span>      <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="mf">27.78</span>        <span class="err">┆</span> <span class="mf">2.5</span>             <span class="err">┆</span> <span class="mf">0.0</span>         <span class="err">┆</span> <span class="mf">0.75</span>            <span class="err">│</span>
<span class="err">│</span>            <span class="err">┆</span>            <span class="err">┆</span> <span class="mi">19</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">06</span>         <span class="err">┆</span> <span class="mi">19</span><span class="p">:</span><span class="mi">48</span><span class="p">:</span><span class="mi">31</span>        <span class="err">┆</span>   <span class="err">┆</span>              <span class="err">┆</span>                 <span class="err">┆</span>             <span class="err">┆</span>                 <span class="err">│</span>
<span class="err">│</span> <span class="nb">max</span>        <span class="err">┆</span> <span class="mf">7.0</span>        <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">01</span>       <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">01</span>      <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="mf">863380.37</span>    <span class="err">┆</span> <span class="mf">2.5</span>             <span class="err">┆</span> <span class="mf">6.75</span>        <span class="err">┆</span> <span class="mf">0.75</span>            <span class="err">│</span>
<span class="err">│</span>            <span class="err">┆</span>            <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">44</span>         <span class="err">┆</span> <span class="mi">23</span><span class="p">:</span><span class="mi">44</span><span class="p">:</span><span class="mi">11</span>        <span class="err">┆</span>   <span class="err">┆</span>              <span class="err">┆</span>                 <span class="err">┆</span>             <span class="err">┆</span>                 <span class="err">│</span>
<span class="err">└────────────┴────────────┴──────────────────┴─────────────────┴───┴──────────────┴─────────────────┴─────────────┴─────────────────┘</span>
</pre></div>
</div>
</div>
</div></div>
</section>
<section id="indexing">
<h4>Indexing<a class="headerlink" href="#indexing" title="Link to this heading">¶</a></h4>
<p>We can index data in the dataframe as follows:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-3-UGFuZGFz" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-3-UGFuZGFz" name="UGFuZGFz" role="tab" tabindex="0">Pandas</button><button aria-controls="panel-3-UG9sYXJz" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-3-UG9sYXJz" name="UG9sYXJz" role="tab" tabindex="-1">Polars</button></div><div aria-labelledby="tab-3-UGFuZGFz" class="sphinx-tabs-panel group-tab" id="panel-3-UGFuZGFz" name="UGFuZGFz" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># With this we can select a column</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;VendorID&#39;</span><span class="p">]</span> <span class="c1"># Could also be df.VendorID </span>
</pre></div>
</div>
<div class="dropdown exercise important admonition" id="exercise-5">
<p class="admonition-title">Output</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="mi">0</span>          <span class="mi">1</span>
<span class="mi">1</span>          <span class="mi">1</span>
<span class="mi">2</span>          <span class="mi">1</span>
<span class="mi">3</span>          <span class="mi">2</span>
<span class="mi">4</span>          <span class="mi">2</span>
          <span class="o">..</span>
<span class="mi">3475221</span>    <span class="mi">2</span>
<span class="mi">3475222</span>    <span class="mi">2</span>
<span class="mi">3475223</span>    <span class="mi">2</span>
<span class="mi">3475224</span>    <span class="mi">2</span>
<span class="mi">3475225</span>    <span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get a row </span>
<span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1000</span><span class="p">,:]</span>
</pre></div>
</div>
<div class="dropdown exercise important admonition" id="exercise-6">
<p class="admonition-title">Output</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">VendorID</span>                                   <span class="mi">2</span>
<span class="n">tpep_pickup_datetime</span>     <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">08</span><span class="p">:</span><span class="mi">06</span>
<span class="n">tpep_dropoff_datetime</span>    <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">20</span>
<span class="n">passenger_count</span>                          <span class="mf">4.0</span>
<span class="n">trip_distance</span>                           <span class="mf">1.53</span>
<span class="n">RatecodeID</span>                               <span class="mf">1.0</span>
<span class="n">store_and_fwd_flag</span>                         <span class="n">N</span>
<span class="n">PULocationID</span>                             <span class="mi">114</span>
<span class="n">DOLocationID</span>                              <span class="mi">90</span>
<span class="n">payment_type</span>                               <span class="mi">1</span>
<span class="n">fare_amount</span>                             <span class="mf">10.0</span>
<span class="n">extra</span>                                    <span class="mf">1.0</span>
<span class="n">mta_tax</span>                                  <span class="mf">0.5</span>
<span class="n">tip_amount</span>                              <span class="mf">2.25</span>
<span class="n">tolls_amount</span>                             <span class="mf">0.0</span>
<span class="n">improvement_surcharge</span>                    <span class="mf">1.0</span>
<span class="n">total_amount</span>                           <span class="mf">17.25</span>
<span class="n">congestion_surcharge</span>                     <span class="mf">2.5</span>
<span class="n">Airport_fee</span>                              <span class="mf">0.0</span>
<span class="n">cbd_congestion_fee</span>                       <span class="mf">0.0</span>
<span class="n">Name</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">object</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1000</span><span class="p">,:]</span>
<span class="n">VendorID</span>                                   <span class="mi">2</span>
<span class="n">tpep_pickup_datetime</span>     <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">08</span><span class="p">:</span><span class="mi">06</span>
<span class="n">tpep_dropoff_datetime</span>    <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">20</span>
<span class="n">passenger_count</span>                          <span class="mf">4.0</span>
<span class="n">trip_distance</span>                           <span class="mf">1.53</span>
<span class="n">RatecodeID</span>                               <span class="mf">1.0</span>
<span class="n">store_and_fwd_flag</span>                         <span class="n">N</span>
<span class="n">PULocationID</span>                             <span class="mi">114</span>
<span class="n">DOLocationID</span>                              <span class="mi">90</span>
<span class="n">payment_type</span>                               <span class="mi">1</span>
<span class="n">fare_amount</span>                             <span class="mf">10.0</span>
<span class="n">extra</span>                                    <span class="mf">1.0</span>
<span class="n">mta_tax</span>                                  <span class="mf">0.5</span>
<span class="n">tip_amount</span>                              <span class="mf">2.25</span>
<span class="n">tolls_amount</span>                             <span class="mf">0.0</span>
<span class="n">improvement_surcharge</span>                    <span class="mf">1.0</span>
<span class="n">total_amount</span>                           <span class="mf">17.25</span>
<span class="n">congestion_surcharge</span>                     <span class="mf">2.5</span>
<span class="n">Airport_fee</span>                              <span class="mf">0.0</span>
<span class="n">cbd_congestion_fee</span>                       <span class="mf">0.0</span>
</pre></div>
</div>
</div>
</div><div aria-labelledby="tab-3-UG9sYXJz" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-3-UG9sYXJz" name="UG9sYXJz" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;VendorID&quot;</span><span class="p">]</span> <span class="c1"># A more Polars-y idiom is to use df.select([&quot;VendorID&quot;])</span>
</pre></div>
</div>
<div class="dropdown exercise important admonition" id="exercise-7">
<p class="admonition-title">Output</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="mi">3_475_226</span><span class="p">,)</span>
<span class="n">Series</span><span class="p">:</span> <span class="s1">&#39;VendorID&#39;</span> <span class="p">[</span><span class="n">i32</span><span class="p">]</span>
<span class="p">[</span>
 <span class="mi">1</span>
 <span class="mi">1</span>
 <span class="mi">1</span>
 <span class="mi">2</span>
 <span class="mi">2</span>
 <span class="err">…</span>
 <span class="mi">2</span>
 <span class="mi">2</span>
 <span class="mi">2</span>
 <span class="mi">2</span>
 <span class="mi">2</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="mi">1000</span><span class="p">][:]</span>
</pre></div>
</div>
<div class="dropdown exercise important admonition" id="exercise-8">
<p class="admonition-title">Output</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="err">┌──────────┬─────────────┬─────────────┬────────────┬───┬────────────┬────────────┬────────────┬────────────┐</span>
<span class="err">│</span> <span class="n">VendorID</span> <span class="err">┆</span> <span class="n">tpep_pickup</span> <span class="err">┆</span> <span class="n">tpep_dropof</span> <span class="err">┆</span> <span class="n">passenger_</span> <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="n">total_amou</span> <span class="err">┆</span> <span class="n">congestion</span> <span class="err">┆</span> <span class="n">Airport_fe</span> <span class="err">┆</span> <span class="n">cbd_conges</span> <span class="err">│</span>
<span class="err">│</span> <span class="o">---</span>      <span class="err">┆</span> <span class="n">_datetime</span>   <span class="err">┆</span> <span class="n">f_datetime</span>  <span class="err">┆</span> <span class="n">count</span>      <span class="err">┆</span>   <span class="err">┆</span> <span class="n">nt</span>         <span class="err">┆</span> <span class="n">_surcharge</span> <span class="err">┆</span> <span class="n">e</span>          <span class="err">┆</span> <span class="n">tion_fee</span>   <span class="err">│</span>
<span class="err">│</span> <span class="n">i32</span>      <span class="err">┆</span> <span class="o">---</span>         <span class="err">┆</span> <span class="o">---</span>         <span class="err">┆</span> <span class="o">---</span>        <span class="err">┆</span>   <span class="err">┆</span> <span class="o">---</span>        <span class="err">┆</span> <span class="o">---</span>        <span class="err">┆</span> <span class="o">---</span>        <span class="err">┆</span> <span class="o">---</span>        <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="n">datetime</span><span class="p">[</span><span class="n">μs</span> <span class="err">┆</span> <span class="n">datetime</span><span class="p">[</span><span class="n">μs</span> <span class="err">┆</span> <span class="n">i64</span>        <span class="err">┆</span>   <span class="err">┆</span> <span class="n">f64</span>        <span class="err">┆</span> <span class="n">f64</span>        <span class="err">┆</span> <span class="n">f64</span>        <span class="err">┆</span> <span class="n">f64</span>        <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="p">]</span>           <span class="err">┆</span> <span class="p">]</span>           <span class="err">┆</span>            <span class="err">┆</span>   <span class="err">┆</span>            <span class="err">┆</span>            <span class="err">┆</span>            <span class="err">┆</span>            <span class="err">│</span>
<span class="err">╞══════════╪═════════════╪═════════════╪════════════╪═══╪════════════╪════════════╪════════════╪════════════╡</span>
<span class="err">│</span> <span class="mi">2</span>        <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span>  <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span>  <span class="err">┆</span> <span class="mi">4</span>          <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="mf">17.25</span>      <span class="err">┆</span> <span class="mf">2.5</span>        <span class="err">┆</span> <span class="mf">0.0</span>        <span class="err">┆</span> <span class="mf">0.0</span>        <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">08</span><span class="p">:</span><span class="mi">06</span>    <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">20</span>    <span class="err">┆</span>            <span class="err">┆</span>   <span class="err">┆</span>            <span class="err">┆</span>            <span class="err">┆</span>            <span class="err">┆</span>            <span class="err">│</span>
<span class="err">└──────────┴─────────────┴─────────────┴────────────┴───┴────────────┴────────────┴────────────┴────────────┘</span>
</pre></div>
</div>
</div>
</div></div>
<p>In both cases, a similar syntax can be used to do in-place modification (e.g. <code class="docutils literal notranslate"><span class="pre">df[row][column]=...</span></code>).
Please note that this kind of replacement carries a big performance penalty,
which is designed to do column-wide operations with minimal overhead. This is
commonly achieved through the <a class="reference external" href="https://docs.pola.rs/user-guide/concepts/expressions-and-contexts/">expression API</a>, as detailed in the next section.</p>
</section>
<section id="common-workflows">
<h4>Common workflows<a class="headerlink" href="#common-workflows" title="Link to this heading">¶</a></h4>
<p>It is quite common to stratify (i.e. divide the samples into a number of groups
based on categorical variables) to produce descriptive statistics (i.e.
statistics that provide a summary of the samples and do not aim to predict
anything regarding the population it comes from). This is commonly achieved
through a <code class="docutils literal notranslate"><span class="pre">group-by</span></code> workflow, where the following happens:</p>
<ul class="simple">
<li><p>Splitting: data is partitioned into different groups based on some criterion</p></li>
<li><p>Applying: applying a function/performing a calculation to each group</p></li>
<li><p>Combining: assembling a dataframe (of potentially any size) with the results.</p></li>
</ul>
<p>This is type of workflow is represented below.</p>
<figure class="align-default" id="id3">
<img alt="split-apply-combine" src="_images/groupby.png" />
<figcaption>
<p><span class="caption-text">Source: <a class="reference external" href="https://earth-env-data-science.github.io/intro.html">Earth and environmental data science</a></span><a class="headerlink" href="#id3" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>As an example, let us try to to compute the total fare for each hour, split
by payment type.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-4-UGFuZGFz" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-4-UGFuZGFz" name="UGFuZGFz" role="tab" tabindex="0">Pandas</button><button aria-controls="panel-4-UG9sYXJz" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-4-UG9sYXJz" name="UG9sYXJz" role="tab" tabindex="-1">Polars</button></div><div aria-labelledby="tab-4-UGFuZGFz" class="sphinx-tabs-panel group-tab" id="panel-4-UGFuZGFz" name="UGFuZGFz" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#First let us extract the hour from the tpep_pickup_datetime column </span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;hour&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;tpep_pickup_datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span> 

<span class="n">hourly_fare</span> <span class="o">=</span> <span class="p">(</span>
  <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;hour&#39;</span><span class="p">,</span> <span class="s1">&#39;payment_type&#39;</span><span class="p">],</span> <span class="n">observed</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;fare_amount&#39;</span><span class="p">]</span>
  <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
  <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
  <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;hour&#39;</span><span class="p">,</span> <span class="s1">&#39;payment_type&#39;</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="dropdown exercise important admonition" id="exercise-9">
<p class="admonition-title">Output</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>     <span class="n">hour</span>  <span class="n">payment_type</span>  <span class="n">fare_amount</span>
<span class="mi">0</span>       <span class="mi">0</span>             <span class="mi">0</span>    <span class="mf">352227.86</span>
<span class="mi">1</span>       <span class="mi">0</span>             <span class="mi">1</span>   <span class="mf">1088201.12</span>
<span class="mi">2</span>       <span class="mi">0</span>             <span class="mi">2</span>    <span class="mf">156546.07</span>
<span class="mi">3</span>       <span class="mi">0</span>             <span class="mi">3</span>      <span class="mf">3537.91</span>
<span class="mi">4</span>       <span class="mi">0</span>             <span class="mi">4</span>      <span class="mf">3941.24</span>
<span class="o">..</span>    <span class="o">...</span>           <span class="o">...</span>          <span class="o">...</span>
<span class="mi">116</span>    <span class="mi">23</span>             <span class="mi">0</span>    <span class="mf">534063.76</span>
<span class="mi">117</span>    <span class="mi">23</span>             <span class="mi">1</span>   <span class="mf">1618143.37</span>
<span class="mi">118</span>    <span class="mi">23</span>             <span class="mi">2</span>    <span class="mf">219991.22</span>
<span class="mi">119</span>    <span class="mi">23</span>             <span class="mi">3</span>      <span class="mf">4765.54</span>
<span class="mi">120</span>    <span class="mi">23</span>             <span class="mi">4</span>      <span class="mf">3293.61</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">groupby</span></code> statement is used to stratify the <code class="docutils literal notranslate"><span class="pre">fare_amount</span></code> column by
hour and payment type. Then the amounts per hour and type get summed and
sorted according to time and payment type.</p>
</div><div aria-labelledby="tab-4-UG9sYXJz" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-4-UG9sYXJz" name="UG9sYXJz" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#First, let us extract the hour from the tpep_pickup_datetime column </span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;tpep_pickup_datetime&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;hour&#39;</span><span class="p">))</span>

<span class="n">hourly_fare</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df</span><span class="o">.</span><span class="n">group_by</span><span class="p">([</span><span class="s1">&#39;hour&#39;</span><span class="p">,</span> <span class="s1">&#39;payment_type&#39;</span><span class="p">])</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="s1">&#39;fare_amount&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s1">&#39;total_fare&#39;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="s1">&#39;hour&#39;</span><span class="p">,</span> <span class="s1">&#39;payment_type&#39;</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="dropdown exercise important admonition" id="exercise-10">
<p class="admonition-title">Output</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="err">┌──────┬──────────────┬────────────┐</span>
<span class="err">│</span> <span class="n">hour</span> <span class="err">┆</span> <span class="n">payment_type</span> <span class="err">┆</span> <span class="n">total_fare</span> <span class="err">│</span>
<span class="err">│</span> <span class="o">---</span>  <span class="err">┆</span> <span class="o">---</span>          <span class="err">┆</span> <span class="o">---</span>        <span class="err">│</span>
<span class="err">│</span> <span class="n">i8</span>   <span class="err">┆</span> <span class="n">i64</span>          <span class="err">┆</span> <span class="n">f64</span>        <span class="err">│</span>
<span class="err">╞══════╪══════════════╪════════════╡</span>
<span class="err">│</span> <span class="mi">0</span>    <span class="err">┆</span> <span class="mi">0</span>            <span class="err">┆</span> <span class="mf">352227.86</span>  <span class="err">│</span>
<span class="err">│</span> <span class="mi">0</span>    <span class="err">┆</span> <span class="mi">1</span>            <span class="err">┆</span> <span class="mf">1.0882e6</span>   <span class="err">│</span>
<span class="err">│</span> <span class="mi">0</span>    <span class="err">┆</span> <span class="mi">2</span>            <span class="err">┆</span> <span class="mf">156546.07</span>  <span class="err">│</span>
<span class="err">│</span> <span class="mi">0</span>    <span class="err">┆</span> <span class="mi">3</span>            <span class="err">┆</span> <span class="mf">3537.91</span>    <span class="err">│</span>
<span class="err">│</span> <span class="mi">0</span>    <span class="err">┆</span> <span class="mi">4</span>            <span class="err">┆</span> <span class="mf">3941.24</span>    <span class="err">│</span>
<span class="err">│</span> <span class="err">…</span>    <span class="err">┆</span> <span class="err">…</span>            <span class="err">┆</span> <span class="err">…</span>          <span class="err">│</span>
<span class="err">│</span> <span class="mi">23</span>   <span class="err">┆</span> <span class="mi">0</span>            <span class="err">┆</span> <span class="mf">534063.76</span>  <span class="err">│</span>
<span class="err">│</span> <span class="mi">23</span>   <span class="err">┆</span> <span class="mi">1</span>            <span class="err">┆</span> <span class="mf">1.6181e6</span>   <span class="err">│</span>
<span class="err">│</span> <span class="mi">23</span>   <span class="err">┆</span> <span class="mi">2</span>            <span class="err">┆</span> <span class="mf">219991.22</span>  <span class="err">│</span>
<span class="err">│</span> <span class="mi">23</span>   <span class="err">┆</span> <span class="mi">3</span>            <span class="err">┆</span> <span class="mf">4765.54</span>    <span class="err">│</span>
<span class="err">│</span> <span class="mi">23</span>   <span class="err">┆</span> <span class="mi">4</span>            <span class="err">┆</span> <span class="mf">3293.61</span>    <span class="err">│</span>
<span class="err">└──────┴──────────────┴────────────┘</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">group_by</span></code> statement is used to stratify by hour and payment type,
followed by an aggregated sum of the <code class="docutils literal notranslate"><span class="pre">fare_amount</span></code> column and a sort.
Notice how the syntax has more of a functional programming flavour to it
(<code class="docutils literal notranslate"><span class="pre">pl.col</span></code>, <code class="docutils literal notranslate"><span class="pre">pl.sum</span></code> as pure functions). This will be clarified further in
the next section. Also note that Polars by default spreads the workload
over multiple threads.</p>
</div></div>
</section>
</section>
<section id="idiomatic-polars">
<h3>Idiomatic Polars<a class="headerlink" href="#idiomatic-polars" title="Link to this heading">¶</a></h3>
<p>Polars introduces a few variations to dataset operations compared to the
traditional Pandas approach. In particular, a domain-specific language
(DSL) was developed, where <em>expressions</em> are written to represent dataset
operations and <em>context</em>s provide the environment where they produce a
result.</p>
<section id="expressions">
<h4>Expressions<a class="headerlink" href="#expressions" title="Link to this heading">¶</a></h4>
<p>Let’s say that we created a <code class="docutils literal notranslate"><span class="pre">trip_duration_sec</span></code> column in our NYC cab database
and, given the <code class="docutils literal notranslate"><span class="pre">trip_distance</span></code> column, we want to compute the average speed.
In Polars, this can be achieved with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;trip_distance&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="err">`</span><span class="n">trip_duration_sec</span><span class="err">`</span><span class="p">)</span>
</pre></div>
</div>
<p>This is a lazy representation of an operation we want to perform, which can
be further manipulated or just printed. For it to actually produce data, a
<em>context</em> is needed.</p>
</section>
<section id="contexts">
<h4>Contexts<a class="headerlink" href="#contexts" title="Link to this heading">¶</a></h4>
<p>The same Polars expression can produce different results depending on the
context where it is used. Four common contexts include:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">select</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">with_columns</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">filter</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">group_by</span></code></p></li>
</ul>
<p>Both <code class="docutils literal notranslate"><span class="pre">select</span></code> and <code class="docutils literal notranslate"><span class="pre">with_columns</span></code> can produce new columns, which may be
aggregations, combinations of other columns, or literals. The difference
between the two is that <code class="docutils literal notranslate"><span class="pre">select</span></code> only includes the columns contained in its
input expression, whereas <code class="docutils literal notranslate"><span class="pre">with_columns</span></code> returns a new dataframe which
contains all the columns from the original dataframe and the new ones created
by the expression. To exemplify, using our earlier example of computing the
average speed during a trip, using <code class="docutils literal notranslate"><span class="pre">select</span></code> would yield a single column,
whereas <code class="docutils literal notranslate"><span class="pre">with_columns</span></code> would return the original dataframe with an additional
column called <code class="docutils literal notranslate"><span class="pre">trip</span> <span class="pre">distance</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;trip_distance&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;trip_duration_sec&#39;</span><span class="p">)</span><span class="o">*</span><span class="mi">3600</span><span class="p">)</span>
<span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="mi">3_475_226</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="err">┌───────────────┐</span>
<span class="err">│</span> <span class="n">trip_distance</span> <span class="err">│</span>
<span class="err">│</span> <span class="o">---</span>           <span class="err">│</span>
<span class="err">│</span> <span class="n">f64</span>           <span class="err">│</span>
<span class="err">╞═══════════════╡</span>
<span class="err">│</span> <span class="mf">11.497006</span>     <span class="err">│</span>
<span class="err">│</span> <span class="mf">11.764706</span>     <span class="err">│</span>
<span class="err">│</span> <span class="mf">18.461538</span>     <span class="err">│</span>
<span class="err">│</span> <span class="mf">5.60479</span>       <span class="err">│</span>
<span class="err">│</span> <span class="mf">11.207547</span>     <span class="err">│</span>
<span class="err">│</span> <span class="err">…</span>             <span class="err">│</span>
<span class="err">│</span> <span class="mf">13.68899</span>      <span class="err">│</span>
<span class="err">│</span> <span class="mf">19.42398</span>      <span class="err">│</span>
<span class="err">│</span> <span class="mf">9.879418</span>      <span class="err">│</span>
<span class="err">│</span> <span class="mf">9.339901</span>      <span class="err">│</span>
<span class="err">│</span> <span class="mf">12.781395</span>     <span class="err">│</span>
<span class="err">└───────────────┘</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">((</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;trip_distance&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;trip_duration_sec&#39;</span><span class="p">)</span><span class="o">*</span><span class="mi">3600</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;avg_sp</span>
<span class="n">eed_mph</span><span class="s2">&quot;))</span>
<span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="mi">3_475_226</span><span class="p">,</span> <span class="mi">22</span><span class="p">)</span>
<span class="err">┌──────────┬──────────┬──────────┬──────────┬───┬──────────┬──────────┬──────────┬──────────┐</span>
<span class="err">│</span> <span class="n">VendorID</span> <span class="err">┆</span> <span class="n">tpep_pic</span> <span class="err">┆</span> <span class="n">tpep_dro</span> <span class="err">┆</span> <span class="n">passenge</span> <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="n">Airport_</span> <span class="err">┆</span> <span class="n">cbd_cong</span> <span class="err">┆</span> <span class="n">trip_dur</span> <span class="err">┆</span> <span class="n">avg_spee</span> <span class="err">│</span>
<span class="err">│</span> <span class="o">---</span>      <span class="err">┆</span> <span class="n">kup_date</span> <span class="err">┆</span> <span class="n">poff_dat</span> <span class="err">┆</span> <span class="n">r_count</span>  <span class="err">┆</span>   <span class="err">┆</span> <span class="n">fee</span>      <span class="err">┆</span> <span class="n">estion_f</span> <span class="err">┆</span> <span class="n">ation_se</span> <span class="err">┆</span> <span class="n">d_mph</span>    <span class="err">│</span>
<span class="err">│</span> <span class="n">i32</span>      <span class="err">┆</span> <span class="n">time</span>     <span class="err">┆</span> <span class="n">etime</span>    <span class="err">┆</span> <span class="o">---</span>      <span class="err">┆</span>   <span class="err">┆</span> <span class="o">---</span>      <span class="err">┆</span> <span class="n">ee</span>       <span class="err">┆</span> <span class="n">c</span>        <span class="err">┆</span> <span class="o">---</span>      <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="o">---</span>      <span class="err">┆</span> <span class="o">---</span>      <span class="err">┆</span> <span class="n">i64</span>      <span class="err">┆</span>   <span class="err">┆</span> <span class="n">f64</span>      <span class="err">┆</span> <span class="o">---</span>      <span class="err">┆</span> <span class="o">---</span>      <span class="err">┆</span> <span class="n">f64</span>      <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="n">datetime</span> <span class="err">┆</span> <span class="n">datetime</span> <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span> <span class="n">f64</span>      <span class="err">┆</span> <span class="n">i64</span>      <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="p">[</span><span class="n">μs</span><span class="p">]</span>     <span class="err">┆</span> <span class="p">[</span><span class="n">μs</span><span class="p">]</span>     <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">╞══════════╪══════════╪══════════╪══════════╪═══╪══════════╪══════════╪══════════╪══════════╡</span>
<span class="err">│</span> <span class="mi">1</span>        <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="mi">1</span>        <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">┆</span> <span class="mi">501</span>      <span class="err">┆</span> <span class="mf">11.49700</span> <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">01</span>       <span class="err">┆</span> <span class="mi">01</span>       <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span> <span class="mi">6</span>        <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">38</span> <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">26</span><span class="p">:</span><span class="mi">59</span> <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span>        <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="mi">1</span>        <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">┆</span> <span class="mi">153</span>      <span class="err">┆</span> <span class="mf">11.76470</span> <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">01</span>       <span class="err">┆</span> <span class="mi">01</span>       <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span> <span class="mi">6</span>        <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">40</span> <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">13</span> <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span>        <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="mi">1</span>        <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">┆</span> <span class="mi">117</span>      <span class="err">┆</span> <span class="mf">18.46153</span> <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">01</span>       <span class="err">┆</span> <span class="mi">01</span>       <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span> <span class="mi">8</span>        <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">44</span><span class="p">:</span><span class="mi">04</span> <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mi">01</span> <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span>        <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="mi">3</span>        <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">┆</span> <span class="mi">334</span>      <span class="err">┆</span> <span class="mf">5.60479</span>  <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">01</span>       <span class="err">┆</span> <span class="mi">01</span>       <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">27</span> <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">20</span><span class="p">:</span><span class="mi">01</span> <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span>        <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="mi">3</span>        <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">┆</span> <span class="mi">212</span>      <span class="err">┆</span> <span class="mf">11.20754</span> <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">01</span>       <span class="err">┆</span> <span class="mi">01</span>       <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span> <span class="mi">7</span>        <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mi">34</span> <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mi">06</span> <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span> <span class="err">…</span>        <span class="err">┆</span> <span class="err">…</span>        <span class="err">┆</span> <span class="err">…</span>        <span class="err">┆</span> <span class="err">…</span>        <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="err">…</span>        <span class="err">┆</span> <span class="err">…</span>        <span class="err">┆</span> <span class="err">…</span>        <span class="err">┆</span> <span class="err">…</span>        <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span>        <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="n">null</span>     <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="n">null</span>     <span class="err">┆</span> <span class="mf">0.75</span>     <span class="err">┆</span> <span class="mi">881</span>      <span class="err">┆</span> <span class="mf">13.68899</span> <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">31</span>       <span class="err">┆</span> <span class="mi">31</span>       <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">23</span><span class="p">:</span><span class="mi">01</span><span class="p">:</span><span class="mi">48</span> <span class="err">┆</span> <span class="mi">23</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">29</span> <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span>        <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span> <span class="err">┆</span> <span class="n">null</span>     <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="n">null</span>     <span class="err">┆</span> <span class="mf">0.75</span>     <span class="err">┆</span> <span class="mi">1618</span>     <span class="err">┆</span> <span class="mf">19.42398</span> <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">31</span>       <span class="err">┆</span> <span class="mi">01</span>       <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">23</span><span class="p">:</span><span class="mi">50</span><span class="p">:</span><span class="mi">29</span> <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">27</span> <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span>        <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="n">null</span>     <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="n">null</span>     <span class="err">┆</span> <span class="mf">0.75</span>     <span class="err">┆</span> <span class="mi">962</span>      <span class="err">┆</span> <span class="mf">9.879418</span> <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">31</span>       <span class="err">┆</span> <span class="mi">31</span>       <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">23</span><span class="p">:</span><span class="mi">26</span><span class="p">:</span><span class="mi">59</span> <span class="err">┆</span> <span class="mi">23</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mi">01</span> <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span>        <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="n">null</span>     <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="n">null</span>     <span class="err">┆</span> <span class="mf">0.75</span>     <span class="err">┆</span> <span class="mi">1218</span>     <span class="err">┆</span> <span class="mf">9.339901</span> <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">31</span>       <span class="err">┆</span> <span class="mi">31</span>       <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">23</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">34</span> <span class="err">┆</span> <span class="mi">23</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">52</span> <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span>        <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span> <span class="err">┆</span> <span class="n">null</span>     <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="n">null</span>     <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">┆</span> <span class="mi">645</span>      <span class="err">┆</span> <span class="mf">12.78139</span> <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">31</span>       <span class="err">┆</span> <span class="mi">01</span>       <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span> <span class="mi">5</span>        <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">23</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">42</span> <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">27</span> <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">└──────────┴──────────┴──────────┴──────────┴───┴──────────┴──────────┴──────────┴──────────┘</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">filter</span></code> context filters the rows of a dataframe based on one (or more)
expressions which evaluate to a Boolean, e.g.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;avg_speed_mph&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">shape</span><span class="p">:</span> <span class="p">(</span><span class="mi">104_410</span><span class="p">,</span> <span class="mi">22</span><span class="p">)</span>
<span class="err">┌──────────┬──────────┬──────────┬──────────┬───┬──────────┬──────────┬──────────┬──────────┐</span>
<span class="err">│</span> <span class="n">VendorID</span> <span class="err">┆</span> <span class="n">tpep_pic</span> <span class="err">┆</span> <span class="n">tpep_dro</span> <span class="err">┆</span> <span class="n">passenge</span> <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="n">Airport_</span> <span class="err">┆</span> <span class="n">cbd_cong</span> <span class="err">┆</span> <span class="n">trip_dur</span> <span class="err">┆</span> <span class="n">avg_spee</span> <span class="err">│</span>
<span class="err">│</span> <span class="o">---</span>      <span class="err">┆</span> <span class="n">kup_date</span> <span class="err">┆</span> <span class="n">poff_dat</span> <span class="err">┆</span> <span class="n">r_count</span>  <span class="err">┆</span>   <span class="err">┆</span> <span class="n">fee</span>      <span class="err">┆</span> <span class="n">estion_f</span> <span class="err">┆</span> <span class="n">ation_se</span> <span class="err">┆</span> <span class="n">d_mph</span>    <span class="err">│</span>
<span class="err">│</span> <span class="n">i32</span>      <span class="err">┆</span> <span class="n">time</span>     <span class="err">┆</span> <span class="n">etime</span>    <span class="err">┆</span> <span class="o">---</span>      <span class="err">┆</span>   <span class="err">┆</span> <span class="o">---</span>      <span class="err">┆</span> <span class="n">ee</span>       <span class="err">┆</span> <span class="n">c</span>        <span class="err">┆</span> <span class="o">---</span>      <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="o">---</span>      <span class="err">┆</span> <span class="o">---</span>      <span class="err">┆</span> <span class="n">i64</span>      <span class="err">┆</span>   <span class="err">┆</span> <span class="n">f64</span>      <span class="err">┆</span> <span class="o">---</span>      <span class="err">┆</span> <span class="o">---</span>      <span class="err">┆</span> <span class="n">f64</span>      <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="n">datetime</span> <span class="err">┆</span> <span class="n">datetime</span> <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span> <span class="n">f64</span>      <span class="err">┆</span> <span class="n">i64</span>      <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="p">[</span><span class="n">μs</span><span class="p">]</span>     <span class="err">┆</span> <span class="p">[</span><span class="n">μs</span><span class="p">]</span>     <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">╞══════════╪══════════╪══════════╪══════════╪═══╪══════════╪══════════╪══════════╪══════════╡</span>
<span class="err">│</span> <span class="mi">2</span>        <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="mi">1</span>        <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">┆</span> <span class="mi">10</span>       <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">01</span>       <span class="err">┆</span> <span class="mi">01</span>       <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mi">43</span> <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mi">53</span> <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span>        <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="mi">3</span>        <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">┆</span> <span class="mi">8</span>        <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">01</span>       <span class="err">┆</span> <span class="mi">01</span>       <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">08</span> <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">57</span><span class="p">:</span><span class="mi">16</span> <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span>        <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="mi">1</span>        <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">┆</span> <span class="mi">1910</span>     <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">01</span>       <span class="err">┆</span> <span class="mi">01</span>       <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">40</span> <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">30</span> <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span>        <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="mi">4</span>        <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">┆</span> <span class="mi">5</span>        <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">01</span>       <span class="err">┆</span> <span class="mi">01</span>       <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">49</span> <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">54</span> <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span>        <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="mi">0</span>        <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">┆</span> <span class="mi">2</span>        <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">01</span>       <span class="err">┆</span> <span class="mi">01</span>       <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">42</span> <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">44</span> <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span> <span class="err">…</span>        <span class="err">┆</span> <span class="err">…</span>        <span class="err">┆</span> <span class="err">…</span>        <span class="err">┆</span> <span class="err">…</span>        <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="err">…</span>        <span class="err">┆</span> <span class="err">…</span>        <span class="err">┆</span> <span class="err">…</span>        <span class="err">┆</span> <span class="err">…</span>        <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span>        <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span> <span class="err">┆</span> <span class="n">null</span>     <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="n">null</span>     <span class="err">┆</span> <span class="mf">0.75</span>     <span class="err">┆</span> <span class="mi">266</span>      <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">31</span>       <span class="err">┆</span> <span class="mi">01</span>       <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">23</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">17</span> <span class="err">┆</span> <span class="mi">00</span><span class="p">:</span><span class="mi">03</span><span class="p">:</span><span class="mi">43</span> <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span>        <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="n">null</span>     <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="n">null</span>     <span class="err">┆</span> <span class="mf">0.75</span>     <span class="err">┆</span> <span class="mi">1100</span>     <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">31</span>       <span class="err">┆</span> <span class="mi">31</span>       <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">23</span><span class="p">:</span><span class="mi">17</span><span class="p">:</span><span class="mi">38</span> <span class="err">┆</span> <span class="mi">23</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">58</span> <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span>        <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="n">null</span>     <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="n">null</span>     <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">┆</span> <span class="mi">161</span>      <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">31</span>       <span class="err">┆</span> <span class="mi">31</span>       <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">23</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">25</span> <span class="err">┆</span> <span class="mi">23</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">06</span> <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span>        <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="n">null</span>     <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="n">null</span>     <span class="err">┆</span> <span class="mf">0.75</span>     <span class="err">┆</span> <span class="mi">24</span>       <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">31</span>       <span class="err">┆</span> <span class="mi">31</span>       <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">23</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">42</span> <span class="err">┆</span> <span class="mi">23</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">06</span> <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span> <span class="mi">1</span>        <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span> <span class="err">┆</span> <span class="n">null</span>     <span class="err">┆</span> <span class="err">…</span> <span class="err">┆</span> <span class="n">null</span>     <span class="err">┆</span> <span class="mf">0.75</span>     <span class="err">┆</span> <span class="mi">1556</span>     <span class="err">┆</span> <span class="mf">0.0</span>      <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">31</span>       <span class="err">┆</span> <span class="mi">31</span>       <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">│</span>          <span class="err">┆</span> <span class="mi">23</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">25</span> <span class="err">┆</span> <span class="mi">23</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">21</span> <span class="err">┆</span>          <span class="err">┆</span>   <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">┆</span>          <span class="err">│</span>
<span class="err">└──────────┴──────────┴──────────┴──────────┴───┴──────────┴──────────┴──────────┴──────────┘</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">group_by</span></code> context behaves like its Pandas counterpart.</p>
</section>
<section id="transformations">
<h4>Transformations<a class="headerlink" href="#transformations" title="Link to this heading">¶</a></h4>
<p>A <code class="docutils literal notranslate"><span class="pre">join</span></code> operation combines columns from one or more dataframes into a new
dataframe. There are different joining strategies, which influence how columns
are combined and what rows are included in the final set. A common type is the
<em>equi</em> join, where rows are matched by a key expression. Let us clarify this
with an example. The <code class="docutils literal notranslate"><span class="pre">df</span></code> dataframe does not include specific coordinates for
each pickup and drop-off, rather only a <code class="docutils literal notranslate"><span class="pre">PULocationID</span></code> and a <code class="docutils literal notranslate"><span class="pre">DOLocationID</span></code>.
There is a <code class="docutils literal notranslate"><span class="pre">taxy_zones_xy.csv</span></code> file that contains, for each <code class="docutils literal notranslate"><span class="pre">LocationID</span></code>, the
latitude (X) and longitude (Y) of each location, as well as the name of zone
and borough:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="n">lookup_df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;taxy_zones_xy.csv&#39;</span><span class="p">,</span> <span class="n">has_header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">lookup_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<span class="err">┌────────────┬────────────┬───────────┬─────────────────────────┬───────────────┐</span>
<span class="err">│</span> <span class="n">LocationID</span> <span class="err">┆</span> <span class="n">X</span>          <span class="err">┆</span> <span class="n">Y</span>         <span class="err">┆</span> <span class="n">zone</span>                    <span class="err">┆</span> <span class="n">borough</span>       <span class="err">│</span>
<span class="err">│</span> <span class="o">---</span>        <span class="err">┆</span> <span class="o">---</span>        <span class="err">┆</span> <span class="o">---</span>       <span class="err">┆</span> <span class="o">---</span>                     <span class="err">┆</span> <span class="o">---</span>           <span class="err">│</span>
<span class="err">│</span> <span class="n">i64</span>        <span class="err">┆</span> <span class="n">f64</span>        <span class="err">┆</span> <span class="n">f64</span>       <span class="err">┆</span> <span class="nb">str</span>                     <span class="err">┆</span> <span class="nb">str</span>           <span class="err">│</span>
<span class="err">╞════════════╪════════════╪═══════════╪═════════════════════════╪═══════════════╡</span>
<span class="err">│</span> <span class="mi">1</span>          <span class="err">┆</span> <span class="o">-</span><span class="mf">74.176786</span> <span class="err">┆</span> <span class="mf">40.689516</span> <span class="err">┆</span> <span class="n">Newark</span> <span class="n">Airport</span>          <span class="err">┆</span> <span class="n">EWR</span>           <span class="err">│</span>
<span class="err">│</span> <span class="mi">2</span>          <span class="err">┆</span> <span class="o">-</span><span class="mf">73.826126</span> <span class="err">┆</span> <span class="mf">40.625724</span> <span class="err">┆</span> <span class="n">Jamaica</span> <span class="n">Bay</span>             <span class="err">┆</span> <span class="n">Queens</span>        <span class="err">│</span>
<span class="err">│</span> <span class="mi">3</span>          <span class="err">┆</span> <span class="o">-</span><span class="mf">73.849479</span> <span class="err">┆</span> <span class="mf">40.865888</span> <span class="err">┆</span> <span class="n">Allerton</span><span class="o">/</span><span class="n">Pelham</span> <span class="n">Gardens</span> <span class="err">┆</span> <span class="n">Bronx</span>         <span class="err">│</span>
<span class="err">│</span> <span class="mi">4</span>          <span class="err">┆</span> <span class="o">-</span><span class="mf">73.977023</span> <span class="err">┆</span> <span class="mf">40.724152</span> <span class="err">┆</span> <span class="n">Alphabet</span> <span class="n">City</span>           <span class="err">┆</span> <span class="n">Manhattan</span>     <span class="err">│</span>
<span class="err">│</span> <span class="mi">5</span>          <span class="err">┆</span> <span class="o">-</span><span class="mf">74.18993</span>  <span class="err">┆</span> <span class="mf">40.55034</span>  <span class="err">┆</span> <span class="n">Arden</span> <span class="n">Heights</span>           <span class="err">┆</span> <span class="n">Staten</span> <span class="n">Island</span> <span class="err">│</span>
<span class="err">└────────────┴────────────┴───────────┴─────────────────────────┴───────────────┘</span>
</pre></div>
</div>
<p>This can be used to append these columns to the original df to have some form
of geographical data as follows (e.g. for the <code class="docutils literal notranslate"><span class="pre">PULocationID</span></code>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lookup_df</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;PULocationID&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;LocationID&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span>
<span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_pickup&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>In the line above, <code class="docutils literal notranslate"><span class="pre">left_on</span></code> is used to indicate the <em>key</em> in the original
dataframe, <code class="docutils literal notranslate"><span class="pre">right_on</span></code> is used to specify the <em>key</em> in the <code class="docutils literal notranslate"><span class="pre">lookup_df</span></code> dataframe,
<code class="docutils literal notranslate"><span class="pre">how=left</span></code> means that the columns from the second dataframe will be added to
the first (and not the other way around) and <code class="docutils literal notranslate"><span class="pre">suffix</span></code> is what will be added to
the names of the joined columns (i.e., df will contain columns called <code class="docutils literal notranslate"><span class="pre">X_pickup</span></code>,
<code class="docutils literal notranslate"><span class="pre">Y_pickup</span></code>, <code class="docutils literal notranslate"><span class="pre">zone_pickup</span></code> and <code class="docutils literal notranslate"><span class="pre">borough_pickup</span></code>). More information on join
operations can be found <a class="reference external" href="https://docs.pola.rs/user-guide/transformations/joins/">here</a>.</p>
</section>
</section>
<section id="exercises">
<h3>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">¶</a></h3>
<div class="admonition-joining-geographical-data exercise important admonition" id="exercise-11">
<p class="admonition-title">Joining geographical data</p>
<p>We have already seen how to add actual latitude and longitude for the pickups.
Now do the same for the drop-offs!</p>
<div class="admonition-solution solution important dropdown admonition" id="solution-0">
<p class="admonition-title">Solution</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lookup_df</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;DOLocationID&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;LocationID&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span>
<span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;_dropoff&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition-feature-engineering-enriching-the-dataset exercise important admonition" id="exercise-12">
<p class="admonition-title">Feature engineering: enriching the dataset</p>
<p>We want to understand a bit more of the traffic in the city by creating
new features (i.e. columns), in particular:</p>
<ul class="simple">
<li><p>Split the pickup datetime into hour, minute, day of the week and month
to indentify daily, weekly and monthly trends</p></li>
<li><p>Compute the average speed as an indicator of congestion (low speed -&gt;
traffic jam)</p></li>
<li><p>Stratify the trip distance and fare by zone to identify how expensive
different zones are.
Below is a skeleton of the code, where some lines have been blanked out
for you to fill (marked with <code class="docutils literal notranslate"><span class="pre">TODO:...</span></code>)</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>
<span class="n">raw_df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s1">&#39;yellow_tripdata_2025-01.parquet&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">raw_df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">([</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;tpep_pickup_datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;pickup_hour&quot;</span><span class="p">),</span>
    <span class="c1">#TODO: do this for the minute</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;tpep_pickup_datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day_of_week</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;pickup_dow&quot;</span><span class="p">),</span>   <span class="c1"># Mon=0 … Sun=6</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;tpep_pickup_datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;pickup_month&quot;</span><span class="p">),</span>
    <span class="c1"># Trip duration in seconds</span>
    <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;tpep_dropoff_datetime&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;tpep_pickup_datetime&quot;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
        <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;trip_duration_sec&quot;</span><span class="p">),</span>
<span class="p">])</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_column</span><span class="p">(</span>
    <span class="c1">#TODO: add expression for average velocity here</span>
    <span class="o">.</span><span class="n">replace_nan</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>                        <span class="c1"># protect against div‑by‑zero</span>
    <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;avg_speed_mph&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Compute per‑pickup‑zone statistics once</span>
<span class="n">zone_stats</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;PULocationID&quot;</span><span class="p">)</span>
      <span class="o">.</span><span class="n">agg</span><span class="p">([</span>
          <span class="n">pl</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;fare_amount&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;zone_avg_fare&quot;</span><span class="p">),</span>
          <span class="c1">#TODO: do the same for the trip distance here</span>
          <span class="n">pl</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;zone_trip_cnt&quot;</span><span class="p">),</span>
      <span class="p">])</span>
      <span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;PULocationID&quot;</span><span class="p">:</span> <span class="s2">&quot;pickup_zone_id&quot;</span><span class="p">})</span>   <span class="c1"># avoid name clash later</span>
<span class="p">)</span>

<span class="c1"># Join those stats back onto the original rows</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">zone_stats</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;PULocationID&quot;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;pickup_zone_id&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>While we haven’t covered the <code class="docutils literal notranslate"><span class="pre">join</span></code> instruction earlier, its main role
is to “spread” the <code class="docutils literal notranslate"><span class="pre">zone_stats</span></code> over all the rides in the original dataframe
(i.e. write the <code class="docutils literal notranslate"><span class="pre">zone_avg_fare</span></code> on each ride in <code class="docutils literal notranslate"><span class="pre">df</span></code>). <code class="docutils literal notranslate"><span class="pre">join</span></code> has its roots
in relational databases, where different tables can be merged based on a
common column.</p>
<div class="admonition-solution solution important dropdown admonition" id="solution-1">
<p class="admonition-title">Solution</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>
<span class="n">raw_df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s1">&#39;yellow_tripdata_2025-01.parquet&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">raw_df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">([</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;tpep_pickup_datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;pickup_hour&quot;</span><span class="p">),</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;tpep_pickup_datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">minute</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;pickup_minute&quot;</span><span class="p">),</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;tpep_pickup_datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day_of_week</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;pickup_dow&quot;</span><span class="p">),</span>   <span class="c1"># Mon=0 … Sun=6</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;tpep_pickup_datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;pickup_month&quot;</span><span class="p">),</span>
    <span class="c1"># Trip duration in seconds</span>
    <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;tpep_dropoff_datetime&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;tpep_pickup_datetime&quot;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">seconds</span><span class="p">()</span>
        <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;trip_duration_sec&quot;</span><span class="p">),</span>
<span class="p">])</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">with_column</span><span class="p">(</span>
    <span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;trip_distance&quot;</span><span class="p">)</span> <span class="o">/</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;trip_duration_sec&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">)</span>   <span class="c1"># seconds → hours</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">replace_nan</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>                        <span class="c1"># protect against div‑by‑zero</span>
    <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;avg_speed_mph&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Compute per‑pickup‑zone statistics once</span>
<span class="n">zone_stats</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;PULocationID&quot;</span><span class="p">)</span>
      <span class="o">.</span><span class="n">agg</span><span class="p">([</span>
          <span class="n">pl</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;fare_amount&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;zone_avg_fare&quot;</span><span class="p">),</span>
          <span class="n">pl</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;trip_distance&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;zone_avg_dist&quot;</span><span class="p">),</span>
          <span class="n">pl</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;zone_trip_cnt&quot;</span><span class="p">),</span>
      <span class="p">])</span>
      <span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;PULocationID&quot;</span><span class="p">:</span> <span class="s2">&quot;pickup_zone_id&quot;</span><span class="p">})</span>   <span class="c1"># avoid name clash later</span>
<span class="p">)</span>

<span class="c1"># Join those stats back onto the original rows</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">zone_stats</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;PULocationID&quot;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;pickup_zone_id&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition-more-feature-engineering exercise important admonition" id="exercise-13">
<p class="admonition-title">More feature engineering!</p>
<p>Similarly to the exercise above, define the following features in the data:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pickup_hour</span></code> extracted from <code class="docutils literal notranslate"><span class="pre">tpep_pickup_time</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">is_weekend</span></code>, a Boolean value for each trip</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">avg_speed_mph</span></code>, exactly as before</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tip_to_fare_ratio</span></code>, dividing the tip amount by the total fare. Be careful
with division by 0</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fare_per_mile</span></code>, dividing the total fare by the distance</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dist_per_passenger</span></code>, the average distance travelled by each passenger
(sum of all trip distances divided by number of trips)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">speed_per_pickup_area</span></code>, the average velocity stratified by pickup location</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dropoff_trip_count</span></code>, count of trips stratified per dropoff location</p></li>
</ul>
<div class="admonition-solution solution important dropdown admonition" id="solution-2">
<p class="admonition-title">Solution</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>
<span class="n">raw_df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="s2">&quot;yellow_tripdata_2025-01.parquet&quot;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">raw_df</span><span class="o">.</span><span class="n">with_columns</span><span class="p">([</span>
    <span class="c1"># 1. pickup_hour</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;tpep_pickup_datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;pickup_hour&quot;</span><span class="p">),</span>

    <span class="c1"># 2. is_weekend (Sat=5, Sun=6)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;tpep_pickup_datetime&quot;</span><span class="p">)</span>
      <span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day_of_week</span><span class="p">()</span>
      <span class="o">.</span><span class="n">is_in</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
      <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;is_weekend&quot;</span><span class="p">),</span>

    <span class="c1"># 3. trip_duration_sec</span>
    <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;tpep_dropoff_datetime&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;tpep_pickup_datetime&quot;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">seconds</span><span class="p">()</span>
        <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;trip_duration_sec&quot;</span><span class="p">),</span>

    <span class="c1"># 4. avg_speed_mph</span>
    <span class="p">(</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;trip_distance&quot;</span><span class="p">)</span> <span class="o">/</span>
        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;trip_duration_sec&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">replace_nan</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>                       <span class="c1"># protect against div‑by‑zero</span>
    <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;avg_speed_mph&quot;</span><span class="p">),</span>

    <span class="c1"># 5. tip_to_fare_ratio</span>
    <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;tip_amount&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;fare_amount&quot;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">replace_inf</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace_nan</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;tip_to_fare_ratio&quot;</span><span class="p">),</span>

    <span class="c1"># 6. fare_per_mile</span>
    <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;fare_amount&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;trip_distance&quot;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">replace_inf</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace_nan</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;fare_per_mile&quot;</span><span class="p">),</span>

    <span class="c1"># 7. dist_per_passenger</span>
    <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;trip_distance&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;passenger_count&quot;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">replace_inf</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace_nan</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;dist_per_passenger&quot;</span><span class="p">),</span>
<span class="p">])</span>

<span class="n">dropoff_stats</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;DOLocationID&quot;</span><span class="p">)</span>
      <span class="o">.</span><span class="n">agg</span><span class="p">([</span>
          <span class="n">pl</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;avg_speed_mph&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;dropoff_avg_speed&quot;</span><span class="p">),</span>
          <span class="n">pl</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;dropoff_trip_cnt&quot;</span><span class="p">),</span>
      <span class="p">])</span>
      <span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;DOLocationID&quot;</span><span class="p">:</span> <span class="s2">&quot;dropoff_zone_id&quot;</span><span class="p">})</span>   <span class="c1"># avoid name clash later</span>
<span class="p">)</span>

<span class="c1"># Join the per‑zone stats back onto every row</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dropoff_stats</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;DOLocationID&quot;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;dropoff_zone_id&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>

</pre></div>
</div>
</div>
</div>
</section>
<section id="summary">
<h3>Summary<a class="headerlink" href="#summary" title="Link to this heading">¶</a></h3>
<p>We have seen how to deal with common workflows in both Pandas and Polars,
starting from basic tasks like opening a dataset and inspecting it to performing
split-apply-combine pipelines. We have seen how to use Polars to manipulate
datasets and perform some basic feature engineering.</p>
<div class="admonition-keypoints keypoints admonition" id="keypoints-0">
<p class="admonition-title">Keypoints</p>
<ul class="simple">
<li><p>Dataframes are combinations of series</p></li>
<li><p>Both Pandas and Polars can be used to manipulate them</p></li>
<li><p>The expression API in Polars allows to perform advanced operations with a
simple DSL.</p></li>
</ul>
</div>
</section>
<section id="see-also">
<h3>See also<a class="headerlink" href="#see-also" title="Link to this heading">¶</a></h3>
<p>There is a lot more to Polars than what we covered in this short introduction.
For example, queries like the ones we introduced can be performed lazily, i.e.
just declared and then run all together, giving the backend a chance to
optimise them. This can dramatically improve performance in the case of complex
queries. For this and a lot more, we refer you to the official
<a class="reference external" href="https://docs.pola.rs/">documentation</a>.</p>
</section>
</section>
<span id="document-interfacing-with-storage"></span><section id="storage-serialisation-backends">
<h2>Storage &amp; serialisation backends<a class="headerlink" href="#storage-serialisation-backends" title="Link to this heading">¶</a></h2>
<div class="admonition-questions questions admonition" id="questions-0">
<p class="admonition-title">Questions</p>
<ul class="simple">
<li><p>What syntax is used to make a lesson?</p></li>
<li><p>How do you structure a lesson effectively for teaching?</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">questions</span></code> are at the top of a lesson and provide a starting
point for what you might learn.  It is usually a bulleted list.</p></li>
</ul>
</div>
<div class="admonition-objectives objectives admonition" id="objectives-0">
<p class="admonition-title">Objectives</p>
<ul class="simple">
<li><p>Show a complete lesson page with all of the most common
structures.</p></li>
<li><p>…</p></li>
</ul>
<p>This is also a holdover from the carpentries-style.  It could
usually be left off.</p>
</div>
<p>The introduction should be a high level overview of what is on the
page and why it is interesting.</p>
<p>The lines below (only in the source) will set the default highlighting
language for the entire page.</p>
<section id="section">
<h3>Section<a class="headerlink" href="#section" title="Link to this heading">¶</a></h3>
<p>A section.</p>
<div class="admonition-discussion discussion important admonition" id="discussion-0">
<p class="admonition-title">Discussion</p>
<p>Discuss the following.</p>
<ul class="simple">
<li><p>A discussion section</p></li>
<li><p>Another discussion topic</p></li>
</ul>
</div>
</section>
<section id="id1">
<h3>Section<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;hello world&quot;</span><span class="p">)</span>
<span class="c1"># This uses the default highlighting language</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;hello world)</span>
</pre></div>
</div>
</section>
<section id="exercises-description">
<h3>Exercises: description<a class="headerlink" href="#exercises-description" title="Link to this heading">¶</a></h3>
<div class="admonition-exercise-topic-1-imperative-description-of-exercise exercise important admonition" id="exercise-0">
<p class="admonition-title">Exercise Topic-1: imperative description of exercise</p>
<p>Exercise text here.</p>
</div>
<div class="admonition-solution solution important dropdown admonition" id="solution-0">
<p class="admonition-title">Solution</p>
<p>Solution text here</p>
</div>
</section>
<section id="summary">
<h3>Summary<a class="headerlink" href="#summary" title="Link to this heading">¶</a></h3>
<p>A Summary of what you learned and why it might be useful.  Maybe a
hint of what comes next.</p>
</section>
<section id="see-also">
<h3>See also<a class="headerlink" href="#see-also" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>Other relevant links</p></li>
<li><p>Other link</p></li>
</ul>
<div class="admonition-keypoints keypoints admonition" id="keypoints-0">
<p class="admonition-title">Keypoints</p>
<ul class="simple">
<li><p>What the learner should take away</p></li>
<li><p>point 2</p></li>
<li><p>…</p></li>
</ul>
<p>This is another holdover from the carpentries style.  This perhaps
is better done in a “summary” section.</p>
</div>
</section>
</section>
<span id="document-visualisation"></span><section id="visualisations-and-dashboards">
<h2>Visualisations and dashboards<a class="headerlink" href="#visualisations-and-dashboards" title="Link to this heading">¶</a></h2>
<div class="admonition-questions questions admonition" id="questions-0">
<p class="admonition-title">Questions</p>
<ul class="simple">
<li><p>What syntax is used to make a lesson?</p></li>
<li><p>How do you structure a lesson effectively for teaching?</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">questions</span></code> are at the top of a lesson and provide a starting
point for what you might learn.  It is usually a bulleted list.</p></li>
</ul>
</div>
<div class="admonition-objectives objectives admonition" id="objectives-0">
<p class="admonition-title">Objectives</p>
<ul class="simple">
<li><p>Show a complete lesson page with all of the most common
structures.</p></li>
<li><p>…</p></li>
</ul>
<p>This is also a holdover from the carpentries-style.  It could
usually be left off.</p>
</div>
<p>The introduction should be a high level overview of what is on the
page and why it is interesting.</p>
<p>The lines below (only in the source) will set the default highlighting
language for the entire page.</p>
<section id="section">
<h3>Section<a class="headerlink" href="#section" title="Link to this heading">¶</a></h3>
<p>A section.</p>
<div class="admonition-discussion discussion important admonition" id="discussion-0">
<p class="admonition-title">Discussion</p>
<p>Discuss the following.</p>
<ul class="simple">
<li><p>A discussion section</p></li>
<li><p>Another discussion topic</p></li>
</ul>
</div>
</section>
<section id="id1">
<h3>Section<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;hello world&quot;</span><span class="p">)</span>
<span class="c1"># This uses the default highlighting language</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;hello world)</span>
</pre></div>
</div>
</section>
<section id="exercises-description">
<h3>Exercises: description<a class="headerlink" href="#exercises-description" title="Link to this heading">¶</a></h3>
<div class="admonition-exercise-topic-1-imperative-description-of-exercise exercise important admonition" id="exercise-0">
<p class="admonition-title">Exercise Topic-1: imperative description of exercise</p>
<p>Exercise text here.</p>
</div>
<div class="admonition-solution solution important dropdown admonition" id="solution-0">
<p class="admonition-title">Solution</p>
<p>Solution text here</p>
</div>
</section>
<section id="summary">
<h3>Summary<a class="headerlink" href="#summary" title="Link to this heading">¶</a></h3>
<p>A Summary of what you learned and why it might be useful.  Maybe a
hint of what comes next.</p>
</section>
<section id="see-also">
<h3>See also<a class="headerlink" href="#see-also" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>Other relevant links</p></li>
<li><p>Other link</p></li>
</ul>
<div class="admonition-keypoints keypoints admonition" id="keypoints-0">
<p class="admonition-title">Keypoints</p>
<ul class="simple">
<li><p>What the learner should take away</p></li>
<li><p>point 2</p></li>
<li><p>…</p></li>
</ul>
<p>This is another holdover from the carpentries style.  This perhaps
is better done in a “summary” section.</p>
</div>
</section>
</section>
<span id="document-benchmarking"></span><section id="benchmarking">
<h2>Benchmarking<a class="headerlink" href="#benchmarking" title="Link to this heading">¶</a></h2>
<div class="admonition-questions questions admonition" id="questions-0">
<p class="admonition-title">Questions</p>
<ul class="simple">
<li><p>What syntax is used to make a lesson?</p></li>
<li><p>How do you structure a lesson effectively for teaching?</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">questions</span></code> are at the top of a lesson and provide a starting
point for what you might learn.  It is usually a bulleted list.</p></li>
</ul>
</div>
<div class="admonition-objectives objectives admonition" id="objectives-0">
<p class="admonition-title">Objectives</p>
<ul class="simple">
<li><p>Show a complete lesson page with all of the most common
structures.</p></li>
<li><p>…</p></li>
</ul>
<p>This is also a holdover from the carpentries-style.  It could
usually be left off.</p>
</div>
<p>The introduction should be a high level overview of what is on the
page and why it is interesting.</p>
<p>The lines below (only in the source) will set the default highlighting
language for the entire page.</p>
<section id="section">
<h3>Section<a class="headerlink" href="#section" title="Link to this heading">¶</a></h3>
<p>A section.</p>
<div class="admonition-discussion discussion important admonition" id="discussion-0">
<p class="admonition-title">Discussion</p>
<p>Discuss the following.</p>
<ul class="simple">
<li><p>A discussion section</p></li>
<li><p>Another discussion topic</p></li>
</ul>
</div>
</section>
<section id="id1">
<h3>Section<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;hello world&quot;</span><span class="p">)</span>
<span class="c1"># This uses the default highlighting language</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;hello world)</span>
</pre></div>
</div>
</section>
<section id="exercises-description">
<h3>Exercises: description<a class="headerlink" href="#exercises-description" title="Link to this heading">¶</a></h3>
<div class="admonition-exercise-topic-1-imperative-description-of-exercise exercise important admonition" id="exercise-0">
<p class="admonition-title">Exercise Topic-1: imperative description of exercise</p>
<p>Exercise text here.</p>
</div>
<div class="admonition-solution solution important dropdown admonition" id="solution-0">
<p class="admonition-title">Solution</p>
<p>Solution text here</p>
</div>
</section>
<section id="summary">
<h3>Summary<a class="headerlink" href="#summary" title="Link to this heading">¶</a></h3>
<p>A Summary of what you learned and why it might be useful.  Maybe a
hint of what comes next.</p>
</section>
<section id="see-also">
<h3>See also<a class="headerlink" href="#see-also" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>Other relevant links</p></li>
<li><p>Other link</p></li>
</ul>
<div class="admonition-keypoints keypoints admonition" id="keypoints-0">
<p class="admonition-title">Keypoints</p>
<ul class="simple">
<li><p>What the learner should take away</p></li>
<li><p>point 2</p></li>
<li><p>…</p></li>
</ul>
<p>This is another holdover from the carpentries style.  This perhaps
is better done in a “summary” section.</p>
</div>
</section>
</section>
<span id="document-multithreading"></span><section id="multithreading">
<h2>Multithreading<a class="headerlink" href="#multithreading" title="Link to this heading">¶</a></h2>
<div class="admonition-questions questions admonition" id="questions-0">
<p class="admonition-title">Questions</p>
<ul class="simple">
<li><p>What syntax is used to make a lesson?</p></li>
<li><p>How do you structure a lesson effectively for teaching?</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">questions</span></code> are at the top of a lesson and provide a starting
point for what you might learn.  It is usually a bulleted list.</p></li>
</ul>
</div>
<div class="admonition-objectives objectives admonition" id="objectives-0">
<p class="admonition-title">Objectives</p>
<ul class="simple">
<li><p>Show a complete lesson page with all of the most common
structures.</p></li>
<li><p>…</p></li>
</ul>
<p>This is also a holdover from the carpentries-style.  It could
usually be left off.</p>
</div>
<p>The introduction should be a high level overview of what is on the
page and why it is interesting.</p>
<p>The lines below (only in the source) will set the default highlighting
language for the entire page.</p>
<section id="section">
<h3>Section<a class="headerlink" href="#section" title="Link to this heading">¶</a></h3>
<p>A section.</p>
<div class="admonition-discussion discussion important admonition" id="discussion-0">
<p class="admonition-title">Discussion</p>
<p>Discuss the following.</p>
<ul class="simple">
<li><p>A discussion section</p></li>
<li><p>Another discussion topic</p></li>
</ul>
</div>
</section>
<section id="id1">
<h3>Section<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h3>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;hello world&quot;</span><span class="p">)</span>
<span class="c1"># This uses the default highlighting language</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;hello world)</span>
</pre></div>
</div>
</section>
<section id="exercises-description">
<h3>Exercises: description<a class="headerlink" href="#exercises-description" title="Link to this heading">¶</a></h3>
<div class="admonition-exercise-topic-1-imperative-description-of-exercise exercise important admonition" id="exercise-0">
<p class="admonition-title">Exercise Topic-1: imperative description of exercise</p>
<p>Exercise text here.</p>
</div>
<div class="admonition-solution solution important dropdown admonition" id="solution-0">
<p class="admonition-title">Solution</p>
<p>Solution text here</p>
</div>
</section>
<section id="summary">
<h3>Summary<a class="headerlink" href="#summary" title="Link to this heading">¶</a></h3>
<p>A Summary of what you learned and why it might be useful.  Maybe a
hint of what comes next.</p>
</section>
<section id="see-also">
<h3>See also<a class="headerlink" href="#see-also" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>Other relevant links</p></li>
<li><p>Other link</p></li>
</ul>
<div class="admonition-keypoints keypoints admonition" id="keypoints-0">
<p class="admonition-title">Keypoints</p>
<ul class="simple">
<li><p>What the learner should take away</p></li>
<li><p>point 2</p></li>
<li><p>…</p></li>
</ul>
<p>This is another holdover from the carpentries style.  This perhaps
is better done in a “summary” section.</p>
</div>
</section>
</section>
<span id="document-dask"></span><section id="dask-for-scalable-analytics">
<span id="dask"></span><h2>Dask for Scalable Analytics<a class="headerlink" href="#dask-for-scalable-analytics" title="Link to this heading">¶</a></h2>
<div class="admonition-objectives objectives admonition" id="objectives-0">
<p class="admonition-title">Objectives</p>
<ul class="simple">
<li><p>Understand how Dask achieves parallelism</p></li>
<li><p>Learn a few common workflows with Dask</p></li>
<li><p>Understand lazy execution</p></li>
</ul>
<div class="admonition-instructor-note instructor-note admonition" id="instructor-note-0">
<p class="admonition-title">Instructor note</p>
<ul class="simple">
<li><p>40 min teaching/type-along</p></li>
<li><p>40 min exercises</p></li>
</ul>
</div>
</div>
<section id="overview">
<h3>Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h3>
<p>An increasingly common problem faced by researchers and data scientists
today is that datasets are becoming larger and larger and modern data analysis
is thus becoming more and more computationally demanding. The first
difficulty to deal with is when the volume of data exceeds one’s computer’s RAM.
Modern laptops/desktops have about 10 GB of RAM. Beyond this threshold,
some special care is required to carry out data analysis.
The next threshold of difficulty is when the data can not even
fit on the hard drive, which is about a couple of TB on a modern laptop.
In this situation, it is better to use an HPC system or a cloud-based solution,
and Dask is a tool that helps us easily extend our familiar data analysis
tools to work with big data. In addition, Dask can also speeds up
our analysis by using multiple CPU cores which makes our work run
faster on laptop, HPC and cloud platforms.</p>
</section>
<section id="what-is-dask">
<h3>What is Dask?<a class="headerlink" href="#what-is-dask" title="Link to this heading">¶</a></h3>
<p>Dask is composed of two parts:</p>
<ul class="simple">
<li><p>Dynamic task scheduling optimized for computation. Similar to other workflow
management systems, but optimized for interactive computational workloads.</p></li>
<li><p>“Big Data” collections like parallel arrays, dataframes, and lists that extend
common interfaces like NumPy, Pandas, or Python iterators to larger-than-memory
or distributed environments. These parallel collections run on top of dynamic
task schedulers.</p></li>
</ul>
<figure class="align-default" id="id1">
<img alt="_images/dask-overview.svg" src="_images/dask-overview.svg" />
<figcaption>
<p><span class="caption-text">High level collections are used to generate task graphs which can be executed
by schedulers on a single machine or a cluster. From the
<a class="reference external" href="https://docs.dask.org/en/stable/">Dask documentation</a>.</span><a class="headerlink" href="#id1" title="Link to this image">¶</a></p>
</figcaption>
</figure>
</section>
<section id="dask-clusters">
<h3>Dask clusters<a class="headerlink" href="#dask-clusters" title="Link to this heading">¶</a></h3>
<p>Dask needs computing resources in order to perform parallel computations.
“Dask Clusters” have different names corresponding to different computing environments,
for example:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">LocalCluster</span></code> on laptop/desktop/cluster</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PBSCluster</span></code> or <code class="docutils literal notranslate"><span class="pre">SLURMCluster</span></code> on HPC</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Kubernetes</span></code> cluster in the cloud</p></li>
</ul>
</div></blockquote>
<p>Each cluster will be allocated with a given number of “workers” associated with
CPU and RAM and the Dask scheduling system automatically maps jobs to each worker.</p>
<p>Dask provides four different schedulers:</p>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Type</p></td>
<td><p>Multi-node</p></td>
<td><p>Description</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">threads</span></code></p></td>
<td><p>No</p></td>
<td><p>A single-machine scheduler backed by a thread pool</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">processes</span></code></p></td>
<td><p>No</p></td>
<td><p>A single-machine scheduler backed by a process pool</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">synchronous</span></code></p></td>
<td><p>No</p></td>
<td><p>A single-threaded scheduler, used for debugging</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">distributed</span></code></p></td>
<td><p>yes</p></td>
<td><p>A distributed scheduler for executing on multiple nodes/machines</p></td>
</tr>
</tbody>
</table>
</div>
<p>Here we will focus on using a <code class="docutils literal notranslate"><span class="pre">LocalCluster</span></code>, and it is recommended to use
a distributed scheduler <code class="docutils literal notranslate"><span class="pre">dask.distributed</span></code>. It is more sophisticated, offers more features,
but requires minimum effort to set up. It can run locally on a laptop and scale up to a cluster.</p>
<div class="dropdown callout admonition" id="callout-0">
<p class="admonition-title">Alternative 1: Initializing a Dask <code class="docutils literal notranslate"><span class="pre">LocalCluster</span></code> via JupyterLab</p>
<p>This makes use of the <code class="docutils literal notranslate"><span class="pre">dask-labextension</span></code> which is pre-installed in our conda environment.</p>
<ol class="arabic">
<li><p>Start New Dask Cluster from the sidebar and by clicking on <code class="docutils literal notranslate"><span class="pre">+</span> <span class="pre">NEW</span></code> button.</p></li>
<li><p>Click on the <code class="docutils literal notranslate"><span class="pre">&lt;</span> <span class="pre">&gt;</span></code> button to inject the client code into a notebook cell. Execute it.</p>
<p><img alt="" src="_images/jlab-dask-1.png" /> <img alt="" src="_images/jlab-dask-2.png" /></p>
</li>
<li><p>You can scale the cluster for more resources or launch the dashboard.
<img alt="" src="_images/jlab-dask-3.png" /></p></li>
</ol>
</div>
<div class="admonition-alternative-2-manual-localcluster callout admonition" id="callout-1">
<p class="admonition-title">Alternative 2: Manual <code class="docutils literal notranslate"><span class="pre">LocalCluster</span></code></p>
<p>We can also start a <code class="docutils literal notranslate"><span class="pre">LocalCluster</span></code> scheduler manually, which can use all
available resources or just a subset.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-QWxsIHJlc291cmNlcw==" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-0-QWxsIHJlc291cmNlcw==" name="QWxsIHJlc291cmNlcw==" role="tab" tabindex="0">All resources</button><button aria-controls="panel-0-U3BlY2lmaWVkIHJlc291cmNlcw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-U3BlY2lmaWVkIHJlc291cmNlcw==" name="U3BlY2lmaWVkIHJlc291cmNlcw==" role="tab" tabindex="-1">Specified resources</button></div><div aria-labelledby="tab-0-QWxsIHJlc291cmNlcw==" class="sphinx-tabs-panel group-tab" id="panel-0-QWxsIHJlc291cmNlcw==" name="QWxsIHJlc291cmNlcw==" role="tabpanel" tabindex="0"><p>We can use all the cores and RAM we have on the machine by:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">dask.distributed</span><span class="w"> </span><span class="kn">import</span> <span class="n">Client</span><span class="p">,</span> <span class="n">LocalCluster</span>
<span class="c1"># create a local cluster</span>
<span class="n">cluster</span> <span class="o">=</span> <span class="n">LocalCluster</span><span class="p">()</span>
<span class="c1"># connect to the cluster we just created</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
<span class="n">client</span>
</pre></div>
</div>
<p>Or you can simply launch a <code class="docutils literal notranslate"><span class="pre">Client()</span></code> call which is shorthand for what is
described above.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">dask.distributed</span><span class="w"> </span><span class="kn">import</span> <span class="n">Client</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span> <span class="c1"># same as Client(processes=True)</span>
<span class="n">client</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-U3BlY2lmaWVkIHJlc291cmNlcw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-U3BlY2lmaWVkIHJlc291cmNlcw==" name="U3BlY2lmaWVkIHJlc291cmNlcw==" role="tabpanel" tabindex="0"><p>This option limits the compute resources available as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">dask.distributed</span><span class="w"> </span><span class="kn">import</span> <span class="n">Client</span><span class="p">,</span> <span class="n">LocalCluster</span>

<span class="n">cluster</span> <span class="o">=</span> <span class="n">LocalCluster</span><span class="p">(</span>
  <span class="n">n_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
  <span class="n">threads_per_worker</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
  <span class="n">memory_limit</span><span class="o">=</span><span class="s1">&#39;4GiB&#39;</span>  <span class="c1"># memory limit per worker</span>
<span class="p">)</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
<span class="n">client</span>
</pre></div>
</div>
</div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When setting up the cluster, one should consider the balance between the number of workers
and threads per worker with different workloads by setting the parameter <code class="docutils literal notranslate"><span class="pre">processes</span></code>.
By default <code class="docutils literal notranslate"><span class="pre">processes=True</span></code> and this is a good choice for workloads that have the GIL,
thus it is better to have more workers and fewer threads per worker. Otherwise, when <code class="docutils literal notranslate"><span class="pre">processes=False</span></code>,
in this case all workers run as threads within the same process as the client,
and they share memory resources. This works well for large datasets.</p>
</div>
<p>Cluster managers also provide useful utilities: for example if a cluster manager supports scaling,
you can modify the number of workers manually or automatically based on workload:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cluster</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># Sets the number of workers to 10</span>
<span class="n">cluster</span><span class="o">.</span><span class="n">adapt</span><span class="p">(</span><span class="n">minimum</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">maximum</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>  <span class="c1"># Allows the cluster to auto scale to 10 when tasks are computed</span>
</pre></div>
</div>
<p>Dask distributed scheduler also provides live feedback via its interactive dashboard.
A link that redirects to the dashboard will prompt in the terminal
where the scheduler is created, and it is also shown when you create a Client and connect the scheduler.
By default, when starting a scheduler on your local machine the dashboard will be served at
<a class="reference external" href="http://localhost:8787/status">http://localhost:8787/status</a> and can be always queried from commond line by:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cluster</span><span class="o">.</span><span class="n">dashboard_link</span>
<span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">8787</span><span class="o">/</span><span class="n">status</span>
<span class="c1"># or</span>
<span class="n">client</span><span class="o">.</span><span class="n">dashboard_link</span>
</pre></div>
</div>
<p>When everything finishes, you can shut down the connected scheduler and workers
by calling the <code class="xref py py-meth docutils literal notranslate"><span class="pre">shutdown()</span></code> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="dask-collections">
<h3>Dask collections<a class="headerlink" href="#dask-collections" title="Link to this heading">¶</a></h3>
<p>Dask provides dynamic parallel task scheduling and
three main high-level collections:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">dask.array</span></code>: Parallel NumPy arrays</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dask.dataframe</span></code>: Parallel Pandas DataFrames</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dask.bag</span></code>: Parallel Python Lists</p></li>
</ul>
</div></blockquote>
<section id="dask-arrays">
<h4>Dask arrays<a class="headerlink" href="#dask-arrays" title="Link to this heading">¶</a></h4>
<p>A Dask array looks and feels a lot like a NumPy array.
However, a Dask array uses the so-called “lazy” execution mode,
which allows one to build up complex, large calculations symbolically
before turning them over the scheduler for execution.</p>
<div class="admonition-lazy-evaluation callout admonition" id="callout-2">
<p class="admonition-title">Lazy evaluation</p>
<p>Contrary to normal computation, lazy execution mode is when all the computations
needed to generate results are symbolically represented, forming a queue of
tasks mapped over data blocks. Nothing is actually computed until the actual
numerical values are needed, e.g. plotting, to print results to the screen or write to disk.
At that point, data is loaded into memory and computation proceeds in a streaming
fashion, block-by-block. The actual computation is controlled by a multi-processing
or thread pool, which allows Dask to take full advantage of multiple processors
available on the computers.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">4000</span><span class="p">)</span>
<span class="n">ones_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
<span class="n">ones_np</span>
<span class="n">ones_np</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">/</span> <span class="mf">1e6</span>
</pre></div>
</div>
<p>Now let’s create the same array using Dask’s array interface.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">dask.array</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">da</span>
<span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">4000</span><span class="p">)</span>
<span class="n">ones</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
<span class="n">ones</span>
</pre></div>
</div>
<p>Although this works, it is not optimized for parallel computation. In order to use all
available computing resources, we also specify the <code class="docutils literal notranslate"><span class="pre">chunks</span></code> argument with Dask,
which describes how the array is split up into sub-arrays:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">dask.array</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">da</span>
<span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">4000</span><span class="p">)</span>
<span class="n">chunk_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">ones</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="n">chunk_shape</span><span class="p">)</span>
<span class="n">ones</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In this course, we will use a chunk shape, but other ways to specify <code class="docutils literal notranslate"><span class="pre">chunks</span></code>
size can be found
<a class="reference external" href="https://docs.dask.org/en/stable/array-chunks.html#specifying-chunk-shapes">here</a>.</p>
</div>
<p>Let us further calculate the sum of the dask array:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sum_da</span> <span class="o">=</span> <span class="n">ones</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
<p>So far, only a task graph of the computation is prepared.
We can visualize the task graph by calling <code class="xref py py-meth docutils literal notranslate"><span class="pre">visualize()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dask</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span><span class="n">sum_da</span><span class="p">)</span>
<span class="c1"># or</span>
<span class="n">sum_da</span><span class="o">.</span><span class="n">visualize</span><span class="p">()</span>
</pre></div>
</div>
<p>One way to trigger the computation is to call <code class="xref py py-meth docutils literal notranslate"><span class="pre">compute()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dask</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">sum_da</span><span class="p">)</span>
<span class="c1"># or</span>
<span class="n">sum_da</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
<p>You can find additional details and examples <a class="reference external" href="https://examples.dask.org/array.html">here</a>.</p>
</section>
<section id="dask-dataframe">
<h4>Dask dataframe<a class="headerlink" href="#dask-dataframe" title="Link to this heading">¶</a></h4>
<p>Dask dataframes split a dataframe into partitions along an index and can be used
in situations where one would normally use Pandas, but this fails due to data size or
insufficient computational efficiency. Specifically, you can use Dask dataframes to:</p>
<ul class="simple">
<li><p>manipulate large datasets, even when these don’t fit in memory</p></li>
<li><p>accelerate long computations by using many cores</p></li>
<li><p>perform distributed computing on large datasets with standard Pandas operations
like groupby, join, and time series computations.</p></li>
</ul>
<p>Let us revisit the dataset containing the Titanic passenger list, and now transform it to
a Dask dataframe:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dask.dataframe</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dd</span>

<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://raw.githubusercontent.com/pandas-dev/pandas/master/doc/data/titanic.csv&quot;</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s2">&quot;Name&quot;</span><span class="p">)</span>
<span class="c1"># read a Dask Dataframe from a Pandas Dataframe</span>
<span class="n">ddf</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">from_pandas</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">npartitions</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>Alternatively you can directly read into a Dask dataframe, whilst also modifying
how the dataframe is partitioned in terms of <code class="docutils literal notranslate"><span class="pre">blocksize</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># blocksize=None which means a single chunk is used</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">blocksize</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span>
<span class="n">ddf</span><span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="n">npartitions</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># blocksize=&quot;4MB&quot; or blocksize=4e6</span>
<span class="n">ddf</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">blocksize</span><span class="o">=</span><span class="s2">&quot;4MB&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span>
<span class="n">ddf</span><span class="o">.</span><span class="n">npartitions</span>

<span class="c1"># blocksize=&quot;default&quot; means the chunk is computed based on</span>
<span class="c1"># available memory and cores with a maximum of 64MB</span>
<span class="n">ddf</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">blocksize</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span>
<span class="n">ddf</span><span class="o">.</span><span class="n">npartitions</span>
</pre></div>
</div>
<p>Dask dataframes do not support the entire interface of Pandas dataframes, but
the most <a class="reference external" href="https://docs.dask.org/en/stable/dataframe.html#scope">commonly used methods are available</a>.
For a full listing refer to the
<a class="reference external" href="https://docs.dask.org/en/stable/dataframe-api.html">dask dataframe API</a>.</p>
<p>We can for example perform the group-by operation we did earlier, but this time in parallel:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># add a column</span>
<span class="n">ddf</span><span class="p">[</span><span class="s2">&quot;Child&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddf</span><span class="p">[</span><span class="s2">&quot;Age&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">12</span>
<span class="n">ddf</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;Sex&quot;</span><span class="p">,</span> <span class="s2">&quot;Child&quot;</span><span class="p">])[</span><span class="s2">&quot;Survived&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
<p>However, for a small dataframe like this the overhead of parallelisation will far
outweigh the benefit.</p>
<p>You can find additional details and examples here
<a class="reference external" href="https://examples.dask.org/dataframe.html">https://examples.dask.org/dataframe.html</a>.</p>
</section>
<section id="dask-bag">
<h4>Dask bag<a class="headerlink" href="#dask-bag" title="Link to this heading">¶</a></h4>
<p>A Dask bag enables processing data that can be represented as a sequence of arbitrary
inputs (“messy data”), like in a Python list. Dask Bags are often used to for
preprocessing log files, JSON records, or other user defined Python objects.</p>
<p>We will content ourselves with implementing a dask version of the word-count problem,
specifically the step where we count words in a text.</p>
<div class="admonition-demo-dask-version-of-word-count demo admonition" id="demo-0">
<span id="word-count-problem"></span><p class="admonition-title">Demo: Dask version of word-count</p>
<p>If you have not already cloned or downloaded <code class="docutils literal notranslate"><span class="pre">word-count-hpda</span></code> repository,
<a class="reference external" href="https://github.com/ENCCS/word-count-hpda">get it from here</a>.
Then, navigate to the <code class="docutils literal notranslate"><span class="pre">word-count-hpda</span></code> directory. The serial version (wrapped in
multiple functions in the <code class="docutils literal notranslate"><span class="pre">source/wordcount.py</span></code> code) looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;./data/pg10.txt&#39;</span>
<span class="n">DELIMITERS</span> <span class="o">=</span> <span class="s2">&quot;. , ; : ? $ @ ^ &lt; &gt; # % ` ! * - = ( ) [ ] { } / </span><span class="se">\&quot;</span><span class="s2"> &#39;&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">input_fd</span><span class="p">:</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">input_fd</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>

<span class="n">counts</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">purge</span> <span class="ow">in</span> <span class="n">DELIMITERS</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">purge</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
        <span class="n">word</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">:</span>
            <span class="n">counts</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">counts</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">sorted_counts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
    <span class="nb">list</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span>
    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">key_value</span><span class="p">:</span> <span class="n">key_value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>

<span class="n">sorted_counts</span><span class="p">[:</span><span class="mi">10</span><span class="p">]</span>

</pre></div>
</div>
<p>A very compact <code class="docutils literal notranslate"><span class="pre">dask.bag</span></code> version of this code is as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dask.bag</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">db</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;./data/pg10.txt&#39;</span>
<span class="n">DELIMITERS</span> <span class="o">=</span> <span class="s2">&quot;. , ; : ? $ @ ^ &lt; &gt; # % ` ! * - = ( ) [ ] { } / </span><span class="se">\&quot;</span><span class="s2"> &#39;&quot;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

<span class="n">text</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">read_text</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">blocksize</span><span class="o">=</span><span class="s1">&#39;1MiB&#39;</span><span class="p">)</span>
<span class="n">sorted_counts</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">text</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">word</span><span class="p">:</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DELIMITERS</span><span class="p">)</span>
    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="o">.</span><span class="n">frequencies</span><span class="p">()</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">key</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">sorted_counts</span>
</pre></div>
</div>
<p>The last two steps of the pipeline could also have been done with a dataframe:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>  <span class="p">:</span><span class="n">emphasize</span><span class="o">-</span><span class="n">lines</span><span class="p">:</span> <span class="mi">9</span><span class="o">-</span><span class="mi">10</span>

  <span class="n">filtered</span> <span class="o">=</span> <span class="p">(</span>
      <span class="n">text</span>
      <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">word</span><span class="p">:</span> <span class="n">word</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DELIMITERS</span><span class="p">)</span>
      <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
      <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
      <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
      <span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
  <span class="p">)</span>
  <span class="n">ddf</span> <span class="o">=</span> <span class="n">filtered</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;words&#39;</span><span class="p">])</span>
  <span class="n">ddf</span><span class="p">[</span><span class="s1">&#39;words&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()[:</span><span class="mi">10</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="admonition-when-to-use-dask callout admonition" id="callout-3">
<p class="admonition-title">When to use Dask</p>
<p>There is no benefit from using Dask on small datasets. But imagine we were
analysing a very large text file (all tweets in a year? a genome?). Dask provides
both parallelisation and the ability to utilize RAM on multiple machines.</p>
</div>
</section>
</section>
<section id="exercise-set-1">
<h3>Exercise set 1<a class="headerlink" href="#exercise-set-1" title="Link to this heading">¶</a></h3>
<p>Choose an exercise with the data structure that you are most interested in:
<a class="reference internal" href="#ex-dask-array"><span class="std std-ref">1.1. Using dask.array</span></a>, <a class="reference internal" href="#ex-dask-df"><span class="std std-ref">1.2. Using dask.dataframe</span></a> or <a class="reference internal" href="#ex-dask-bag"><span class="std std-ref">1.3. Using dask.bag</span></a>.</p>
<section id="using-dask-array">
<span id="ex-dask-array"></span><h4>1.1. Using dask.array<a class="headerlink" href="#using-dask-array" title="Link to this heading">¶</a></h4>
<div class="admonition-chunk-size exercise important admonition" id="exercise-0">
<p class="admonition-title">Chunk size</p>
<p>The following example calculate the mean value of a random generated array.
Run the example and see the performance improvement by using dask.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-TnVtUHk=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-1-TnVtUHk=" name="TnVtUHk=" role="tab" tabindex="0">NumPy</button><button aria-controls="panel-1-RGFzaw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-1-RGFzaw==" name="RGFzaw==" role="tab" tabindex="-1">Dask</button></div><div aria-labelledby="tab-1-TnVtUHk=" class="sphinx-tabs-panel group-tab" id="panel-1-TnVtUHk=" name="TnVtUHk=" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="o">%%</span><span class="n">time</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">20000</span><span class="p">,</span> <span class="mi">20000</span><span class="p">))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-1-RGFzaw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-1-RGFzaw==" name="RGFzaw==" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">dask</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dask.array</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">da</span>

<span class="o">%%</span><span class="n">time</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">20000</span><span class="p">,</span> <span class="mi">20000</span><span class="p">),</span> <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">y</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div></div>
<p>But what happens if we use different chunk sizes?
Try out with different chunk sizes:</p>
<ul class="simple">
<li><p>What happens if the dask chunks=(20000,20000)</p></li>
<li><p>What happens if the dask chunks=(250,250)</p></li>
</ul>
<div class="admonition-choice-of-chunk-size solution important dropdown admonition" id="solution-0">
<p class="admonition-title">Choice of chunk size</p>
<p>The choice is problem dependent, but here are a few things to consider:</p>
<p>Each chunk of data should be small enough so that it fits comforably in each worker’s available memory.
Chunk sizes between 10MB-1GB are common, depending on the availability of RAM. Dask will likely
manipulate as many chunks in parallel on one machine as you have cores on that machine.
So if you have a machine with 10 cores and you choose chunks in the 1GB range, Dask is likely to use at least
10 GB of memory. Additionally, there should be enough chunks available so that each worker always has something to work on.</p>
<p>On the otherhand, you also want to avoid chunk sizes that are too small as we see in the exercise.
Every task comes with some overhead which is somewhere between 200us and 1ms. Very large graphs
with millions of tasks will lead to overhead being in the range from minutes to hours which is not recommended.</p>
</div>
</div>
</section>
<section id="using-dask-dataframe">
<span id="ex-dask-df"></span><h4>1.2. Using dask.dataframe<a class="headerlink" href="#using-dask-dataframe" title="Link to this heading">¶</a></h4>
<div class="admonition-benchmarking-dataframe-apply exercise important admonition" id="exercise-1">
<p class="admonition-title">Benchmarking DataFrame.apply()</p>
<p>Recall the :ref:<code class="docutils literal notranslate"><span class="pre">word</span> <span class="pre">count</span> <span class="pre">&lt;word-count-problem&gt;</span></code> project that we encountered
earlier and the :func:<code class="docutils literal notranslate"><span class="pre">scipy.optimize.curve_fit</span></code> function. The
:download:<code class="docutils literal notranslate"><span class="pre">results.csv</span> <span class="pre">&lt;data/results.csv&gt;</span></code> file contains word counts of the 10
most frequent words in different texts, and we want to fit a power law to the
individual distributions in each row.</p>
<p>Here are our fitting functions:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">curve_fit</span>

<span class="k">def</span><span class="w"> </span><span class="nf">powerlaw</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">A</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">fit_powerlaw</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mf">1.0</span>
    <span class="n">params</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">powerlaw</span><span class="p">,</span> <span class="n">xdata</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="n">row</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
<p>Compare the performance of :meth:<code class="docutils literal notranslate"><span class="pre">dask.dataframe.DataFrame.apply</span></code> with
:meth:<code class="docutils literal notranslate"><span class="pre">pandas.DataFrame.apply</span></code> for the this example. You will probably see a
slowdown due to the parallelisation overhead. But what if you add a
<code class="docutils literal notranslate"><span class="pre">time.sleep(0.01)</span></code> inside :meth:<code class="docutils literal notranslate"><span class="pre">fit_powerlaw</span></code> to emulate a time-consuming
calculation?</p>
<div class="dropdown callout admonition" id="callout-4">
<p class="admonition-title">Hints</p>
<ul class="simple">
<li><p>You will need to call :meth:<code class="docutils literal notranslate"><span class="pre">apply</span></code> on the dataframe starting from column 1: <code class="docutils literal notranslate"><span class="pre">dataframe.iloc[:,1:].apply()</span></code></p></li>
<li><p>Remember that both Pandas and Dask have the :meth:<code class="docutils literal notranslate"><span class="pre">read_csv</span></code> function.</p></li>
<li><p>Try repartitioning the dataframe into 4 partitions with <code class="docutils literal notranslate"><span class="pre">ddf4=ddf.repartition(npartitions=4)</span></code>.</p></li>
<li><p>You will probably get a warning in your Dask version that <code class="docutils literal notranslate"><span class="pre">You</span> <span class="pre">did</span> <span class="pre">not</span> <span class="pre">provide</span> <span class="pre">metadata</span></code>.
To remove the warning, add the <code class="docutils literal notranslate"><span class="pre">meta=(None,</span> <span class="pre">&quot;float64&quot;)</span></code> flag to :meth:<code class="docutils literal notranslate"><span class="pre">apply</span></code>. For the
current data, this does not affect the performance.</p></li>
</ul>
</div>
<div class="dropdown callout admonition" id="callout-5">
<p class="admonition-title">More hints with Pandas code</p>
<p>You need to reimplement the highlighted part which creates the
dataframe and applies the :func:<code class="docutils literal notranslate"><span class="pre">fit_powerlaw</span></code> function.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">curve_fit</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="k">def</span><span class="w"> </span><span class="nf">powerlaw</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">A</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">fit_powerlaw</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mf">1.0</span>
    <span class="n">params</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">powerlaw</span><span class="p">,</span> <span class="n">xdata</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="n">row</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>


<span class="hll"><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;https://raw.githubusercontent.com/ENCCS/hpda-python/main/content/data/results.csv&quot;</span><span class="p">)</span>
</span><span class="hll"><span class="o">%</span><span class="k">timeit</span> results = df.iloc[:,1:].apply(fit_powerlaw, axis=1)
</span></pre></div>
</div>
</div>
<div class="admonition-solution solution important dropdown admonition" id="solution-1">
<p class="admonition-title">Solution</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dask.dataframe</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">curve_fit</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="k">def</span><span class="w"> </span><span class="nf">powerlaw</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">A</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">fit_powerlaw</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mf">1.0</span>
    <span class="n">params</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">powerlaw</span><span class="p">,</span> <span class="n">xdata</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">ydata</span><span class="o">=</span><span class="n">row</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">ddf</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;https://raw.githubusercontent.com/ENCCS/hpda-python/main/content/data/results.csv&quot;</span><span class="p">)</span>
<span class="n">ddf4</span><span class="o">=</span><span class="n">ddf</span><span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="n">npartitions</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

<span class="c1"># Note the optional argument ``meta`` which is recommended for dask dataframes. </span>
<span class="c1"># It should contain an empty ``pandas.DataFrame`` or ``pandas.Series`` </span>
<span class="c1"># that matches the dtypes and column names of the output, </span>
<span class="c1"># or a dict of ``{name: dtype}`` or iterable of ``(name, dtype)``.</span>

<span class="n">results</span> <span class="o">=</span> <span class="n">ddf4</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">fit_powerlaw</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">meta</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;float64&quot;</span><span class="p">))</span>
<span class="o">%</span><span class="k">timeit</span> results.compute()
<span class="n">results</span><span class="o">.</span><span class="n">visualize</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="using-dask-bag">
<span id="ex-dask-bag"></span><h4>1.3. Using dask.bag<a class="headerlink" href="#using-dask-bag" title="Link to this heading">¶</a></h4>
<div class="admonition-break-down-the-dask-bag-computational-pipeline exercise important admonition" id="exercise-2">
<p class="admonition-title">Break down the dask.bag computational pipeline</p>
<p>Revisit the
:ref:<code class="docutils literal notranslate"><span class="pre">word</span> <span class="pre">count</span> <span class="pre">problem</span> <span class="pre">&lt;word-count-problem&gt;</span></code>
and the implementation with a <code class="docutils literal notranslate"><span class="pre">dask.bag</span></code> that we saw above.</p>
<ul class="simple">
<li><p>To get a feeling for the computational pipeline, break down the computation into
separate steps and investigate intermediate results using :meth:<code class="docutils literal notranslate"><span class="pre">.compute</span></code>.</p></li>
<li><p>Benchmark the serial and <code class="docutils literal notranslate"><span class="pre">dask.bag</span></code> versions. Do you see any speedup?
What if you have a larger textfile? You can for example concatenate all texts into
a single file: <code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">data/*.txt</span> <span class="pre">&gt;</span> <span class="pre">data/all.txt</span></code>.</p></li>
</ul>
</div>
</section>
</section>
<section id="low-level-interface-delayed">
<h3>Low level interface: delayed<a class="headerlink" href="#low-level-interface-delayed" title="Link to this heading">¶</a></h3>
<p>Sometimes problems don’t fit into one of the collections like
<code class="docutils literal notranslate"><span class="pre">dask.array</span></code> or <code class="docutils literal notranslate"><span class="pre">dask.dataframe</span></code>, they are not as simple as just a big array or dataframe.
In these cases, <code class="docutils literal notranslate"><span class="pre">dask.delayed</span></code> may be the right choice. If the problem is paralellisable,
we can use <code class="docutils literal notranslate"><span class="pre">dask.delayed</span></code> which allows users to make function calls lazy
and thus can be put into a task graph with dependencies.</p>
<p>Consider the following example. The functions are very simple, and they <em>sleep</em>
for a prescribed time to simulate real work:</p>
<p>Let us run the example first, one after the other in sequence:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="o">%%timeit</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">inc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dec</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="c1"># 902 ms ± 367 µs per loop (mean ± std. dev. of 7 runs, 1 loop each)</span>
</pre></div>
</div>
<p>Note that the first two functions <code class="docutils literal notranslate"><span class="pre">inc</span></code> and <code class="docutils literal notranslate"><span class="pre">dec</span></code> don’t depend on each other,
we could have called them in parallel. We can call <code class="docutils literal notranslate"><span class="pre">dask.delayed</span></code> on these functions
to make them lazy and tasks into a graph which we will run later on parallel hardware.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">dask</span>
<span class="n">inc_delay</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">inc</span><span class="p">)</span>
<span class="n">dec_delay</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>
<span class="n">add_delay</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">add</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="o">%%timeit</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">inc_delay</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dec_delay</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">add_delay</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="c1"># 59.6 µs ± 356 ns per loop (mean ± std. dev. of 7 runs, 10,000 loops each)</span>
</pre></div>
</div>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="o">%%timeit</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">inc_delay</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dec_delay</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">add_delay</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">z</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="c1"># 603 ms ± 181 µs per loop (mean ± std. dev. of 7 runs, 1 loop each)</span>
</pre></div>
</div>
<div class="admonition-default-scheduler-for-dask-collections callout admonition" id="callout-6">
<p class="admonition-title">Default scheduler for dask collections</p>
<p><code class="docutils literal notranslate"><span class="pre">dask.array</span></code> and <code class="docutils literal notranslate"><span class="pre">dask.dataframe</span></code> use the <code class="docutils literal notranslate"><span class="pre">threads</span></code> scheduler</p>
<p><code class="docutils literal notranslate"><span class="pre">dask.bag</span></code> uses the <code class="docutils literal notranslate"><span class="pre">processes</span></code> scheduler</p>
<p>In case to change the default scheduler, using <code class="docutils literal notranslate"><span class="pre">dask.config.set</span></code> is recommended:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="c1"># To set globally</span>
<span class="n">dask</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">scheduler</span><span class="o">=</span><span class="s1">&#39;processes&#39;</span><span class="p">)</span>
<span class="n">x</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="c1"># To set it as a context manager</span>
<span class="k">with</span> <span class="n">dask</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">scheduler</span><span class="o">=</span><span class="s1">&#39;threads&#39;</span><span class="p">):</span>
    <span class="n">x</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
<section id="comparison-to-spark">
<h3>Comparison to Spark<a class="headerlink" href="#comparison-to-spark" title="Link to this heading">¶</a></h3>
<p>Dask has much in common with the <a class="reference external" href="https://spark.apache.org/">Apache Spark</a>.
Here are <a class="reference external" href="https://docs.dask.org/en/stable/spark.html">some differences</a>
between the two frameworks:</p>
<ul class="simple">
<li><p>Dask is smaller and more lightweight but is used together with other packages in
the Python ecosystem. Spark is an all-in-one project with its own ecosystem.</p></li>
<li><p>Spark is written in Scala, with some support for Python and R, while Dask is in Python.</p></li>
<li><p>Spark is more focused on business intelligence (SQL, lightweight machine learning) while
Dask is more general and is used more in scientific applications.</p></li>
<li><p>Both Dask and Spark can scale from one to thousands of nodes.</p></li>
<li><p>Dask supports the NumPy model for multidimensional arrays which Spark doesn’t.</p></li>
<li><p>Spark generally expects users to compose computations out of high-level primitives
(map, reduce, groupby, join, etc.), while Dask allows to specify arbitrary task
graphs for more complex and custom systems.</p></li>
</ul>
</section>
<section id="exercise-set-2">
<h3>Exercise set 2<a class="headerlink" href="#exercise-set-2" title="Link to this heading">¶</a></h3>
<div class="admonition-dask-delay exercise important admonition" id="exercise-3">
<p class="admonition-title">Dask delay</p>
<p>We extend the previous example a little bit more by applying the function
on a data array using for loop and adding an <em>if</em> condition:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dask</span>

<span class="k">def</span><span class="w"> </span><span class="nf">inc</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">dec</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>


<span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">inc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">dec</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

<span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
</div>
<p>Please add <code class="docutils literal notranslate"><span class="pre">dask.delayed</span></code> to parallelize the program as much as possible
and check graph visualizations.</p>
<div class="admonition-solution solution important dropdown admonition" id="solution-2">
<p class="admonition-title">Solution</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dask</span>

<span class="k">def</span><span class="w"> </span><span class="nf">inc</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">dec</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span>

<span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>


<span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">inc</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">dec</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">add</span><span class="p">)(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

<span class="n">total</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="nb">sum</span><span class="p">)(</span><span class="n">output</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition-climate-simulation-data-using-xarray-and-dask exercise important admonition" id="exercise-4">
<p class="admonition-title">Climate simulation data using Xarray and Dask</p>
<p>This exercise is working with NetCDF files using Xarray. The files contain
monthly global 2m air temperature for 10 years.
Xarray is chosen due to its ability to seamlessly integrate with Dask
to support parallel computations on datasets.</p>
<p>We will first read data with Dask and Xarray. See
<a class="reference external" href="https://xarray.pydata.org/en/stable/dask.html#reading-and-writing-data">https://xarray.pydata.org/en/stable/dask.html#reading-and-writing-data</a> for more details.</p>
<p>Note that the NetCDF files are here <a class="reference external" href="https://github.com/ENCCS/hpda-python/tree/main/content/data">https://github.com/ENCCS/hpda-python/tree/main/content/data</a> ,
you need to <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">clone</span></code> the repository or download the files to your laptop first.
Then depending on where you put the files,
you may need to adapt the path to the data folder in the Python code.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">dask</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="n">ds</span><span class="o">=</span><span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">(</span><span class="s1">&#39;./data/tas*.nc&#39;</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">use_cftime</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>:func:<code class="docutils literal notranslate"><span class="pre">xarray.open_mfdataset</span></code> is for reading multiple files and will chunk each
file into a single Dask array by default. One could supply the chunks keyword
argument to control the size of the resulting Dask arrays. Passing the keyword
argument <code class="docutils literal notranslate"><span class="pre">parallel=True</span></code> to :func:<code class="docutils literal notranslate"><span class="pre">xarray.open_mfdataset</span></code> will speed up the
reading of large multi-file datasets by executing those read tasks in parallel
using <code class="docutils literal notranslate"><span class="pre">dask.delayed</span></code>.</p>
<p>Explore the following operations line-by-line:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span>
<span class="n">ds</span><span class="o">.</span><span class="n">tas</span>
<span class="c1">#dsnew = ds.chunk({&quot;time&quot;: 1,&quot;lat&quot;: 80,&quot;lon&quot;:80})   # you can further rechunk the data</span>
<span class="c1">#dask.visualize(ds.tas) # do not visualize, the graph is too big</span>
<span class="n">ds</span><span class="p">[</span><span class="s1">&#39;tas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;tas&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">273.15</span>     <span class="c1"># convert from Kelvin to degree Celsius</span>
<span class="n">mean_tas</span><span class="o">=</span><span class="n">ds</span><span class="o">.</span><span class="n">tas</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>  <span class="c1"># lazy compuation</span>
<span class="n">mean_tas</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">RdBu_r</span><span class="p">,</span><span class="n">vmin</span><span class="o">=-</span><span class="mi">50</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span> <span class="c1"># plotting triggers computation</span>
<span class="n">tas_ann</span><span class="o">=</span><span class="n">ds</span><span class="o">.</span><span class="n">tas</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;time.year&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1"># lazy compuation</span>
<span class="n">tas_sto</span><span class="o">=</span><span class="n">tas_ann</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="mf">18.07</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="mf">59.33</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>  <span class="c1"># slicing is lazy as well</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tas_sto</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">tas_sto</span><span class="p">)</span>  <span class="c1"># plotting trigers computation</span>
</pre></div>
</div>
</div>
<div class="admonition-keypoints keypoints admonition" id="keypoints-0">
<p class="admonition-title">Keypoints</p>
<ul class="simple">
<li><p>Dask uses lazy execution</p></li>
<li><p>Dask can parallelize and perform out-of-memory computation.
That is, handle data that would not fit in the memory if loaded at once.</p></li>
<li><p>Only use Dask for processing very large amount of data</p></li>
</ul>
</div>
</section>
</section>
</div>
<div class="toctree-wrapper compound">
<span id="document-dask_opt"></span><section id="dask-ii">
<h2>Dask (II)<a class="headerlink" href="#dask-ii" title="Link to this heading">¶</a></h2>
<div class="admonition-testing-different-schedulers exercise important admonition" id="exercise-0">
<p class="admonition-title">Testing different schedulers</p>
<p>We will test different schedulers and compare the performance on a simple task calculating
the mean of a random generated array.</p>
<p>Here is the code using NumPy:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">dask</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">calc_mean</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="n">n</span><span class="p">))</span>
    <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<p>Here we run the same code using different schedulers from Dask:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-U2VyaWFs" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-0-U2VyaWFs" name="U2VyaWFs" role="tab" tabindex="0">Serial</button><button aria-controls="panel-0-VGhyZWFkcw==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-VGhyZWFkcw==" name="VGhyZWFkcw==" role="tab" tabindex="-1">Threads</button><button aria-controls="panel-0-UHJvY2Vzc2Vz" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-UHJvY2Vzc2Vz" name="UHJvY2Vzc2Vz" role="tab" tabindex="-1">Processes</button><button aria-controls="panel-0-RGlzdHJpYnV0ZWQ=" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-RGlzdHJpYnV0ZWQ=" name="RGlzdHJpYnV0ZWQ=" role="tab" tabindex="-1">Distributed</button></div><div aria-labelledby="tab-0-U2VyaWFs" class="sphinx-tabs-panel group-tab" id="panel-0-U2VyaWFs" name="U2VyaWFs" role="tabpanel" tabindex="0"><div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">100000</span>
<span class="o">%%timeit</span>
<span class="n">rs</span><span class="o">=</span><span class="p">[</span><span class="n">calc_mean</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span>
<span class="c1">#352 ms ± 925 µs per loop (mean ± std. dev. of 7 runs, 1 loop each)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-VGhyZWFkcw==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-VGhyZWFkcw==" name="VGhyZWFkcw==" role="tabpanel" tabindex="0"><div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">dask</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">calc_mean</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="n">n</span><span class="p">))</span>
    <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    
<span class="n">n</span> <span class="o">=</span> <span class="mi">100000</span>
<span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">dask</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">calc_mean</span><span class="p">)(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span>
</pre></div>
</div>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="o">%%timeit</span>
<span class="k">with</span> <span class="n">dask</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">scheduler</span><span class="o">=</span><span class="s1">&#39;threads&#39;</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">mt_1</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<span class="c1">#395 ms ± 18.5 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</span>
</pre></div>
</div>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="o">%%timeit</span>
<span class="k">with</span> <span class="n">dask</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">scheduler</span><span class="o">=</span><span class="s1">&#39;threads&#39;</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">mt_2</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<span class="c1">#1.28 s ± 1.46 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</span>
</pre></div>
</div>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="o">%%timeit</span>
<span class="k">with</span> <span class="n">dask</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">scheduler</span><span class="o">=</span><span class="s1">&#39;threads&#39;</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">mt_4</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<span class="c1">#1.28 s ± 3.84 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-UHJvY2Vzc2Vz" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-UHJvY2Vzc2Vz" name="UHJvY2Vzc2Vz" role="tabpanel" tabindex="0"><div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">dask</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">calc_mean</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="n">n</span><span class="p">))</span>
    <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    
<span class="n">n</span> <span class="o">=</span> <span class="mi">100000</span>
<span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">dask</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">calc_mean</span><span class="p">)(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span>
</pre></div>
</div>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="o">%%timeit</span>
<span class="k">with</span> <span class="n">dask</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">scheduler</span><span class="o">=</span><span class="s1">&#39;processes&#39;</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">mp_1</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<span class="c1">#990 ms ± 39.9 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</span>
</pre></div>
</div>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="o">%%timeit</span>
<span class="k">with</span> <span class="n">dask</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">scheduler</span><span class="o">=</span><span class="s1">&#39;processes&#39;</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">mp_2</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<span class="c1">#881 ms ± 17.9 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</span>
</pre></div>
</div>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="o">%%timeit</span>
<span class="k">with</span> <span class="n">dask</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">scheduler</span><span class="o">=</span><span class="s1">&#39;processes&#39;</span><span class="p">,</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">mp_4</span> <span class="o">=</span> <span class="n">dask</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<span class="c1">#836 ms ± 10.9 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-RGlzdHJpYnV0ZWQ=" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-RGlzdHJpYnV0ZWQ=" name="RGlzdHJpYnV0ZWQ=" role="tabpanel" tabindex="0"><div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">dask</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dask.distributed</span><span class="w"> </span><span class="kn">import</span> <span class="n">Client</span><span class="p">,</span> <span class="n">LocalCluster</span>

<span class="k">def</span><span class="w"> </span><span class="nf">calc_mean</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="n">n</span><span class="p">))</span>
    <span class="k">return</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    
<span class="n">n</span> <span class="o">=</span> <span class="mi">100000</span>
<span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="n">dask</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">calc_mean</span><span class="p">)(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)]</span>

<span class="n">cluster</span> <span class="o">=</span> <span class="n">LocalCluster</span><span class="p">(</span><span class="n">n_workers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">threads_per_worker</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-literalinclude} notranslate"><div class="highlight"><pre><span></span>:language: ipython
:lines: 16-17
</pre></div>
</div>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="n">cluster</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="o">%</span><span class="k">timeit</span> dis_2 = dask.compute(output,n_workers = 2)
<span class="c1">#357 ms ± 131 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</span>
</pre></div>
</div>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="n">cluster</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="o">%</span><span class="k">timeit</span> dis_4 = dask.compute(output,n_workers = 4)
<span class="c1">#265 ms ± 53.2 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)</span>
</pre></div>
</div>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</pre></div>
</div>
</div></div>
<div class="admonition-testing-different-schedulers solution important dropdown admonition" id="solution-0">
<p class="admonition-title">Testing different schedulers</p>
<p>Comparing profiling from mt_1, mt_2 and mt_4: Using <code class="docutils literal notranslate"><span class="pre">threads</span></code> scheduler is limited by the GIL on pure Python code.
In our case, although it is not a pure Python function, it is still limited by GIL, therefore no multi-core speedup</p>
<p>Comparing profiling from mt_1, mp_1 and dis_1: Except for <code class="docutils literal notranslate"><span class="pre">threads</span></code>, the other two schedulers copy data between processes
and this can introduce performance penalties, particularly when the data being transferred between processes is large.</p>
<p>Comparing profiling from serial, mt_1, mp_1 and dis_1: Creating and destroying threads and processes have overheads,
<code class="docutils literal notranslate"><span class="pre">processes</span></code> have even more overhead than <code class="docutils literal notranslate"><span class="pre">threads</span></code></p>
<p>Comparing profiling from mp_1, mp_2 and mp_4: Running multiple processes is only effective when there is enough computational
work to do i.e. CPU-bound tasks. In this very example, most of the time is actually spent on transferring the data
rather than computing the mean</p>
<p>Comparing profiling from <code class="docutils literal notranslate"><span class="pre">processes</span></code> and <code class="docutils literal notranslate"><span class="pre">distributed</span></code>: Using <code class="docutils literal notranslate"><span class="pre">distributed</span></code> scheduler has advantages over <code class="docutils literal notranslate"><span class="pre">processes</span></code>,
this is related to better handling of data copying, i.e. <code class="docutils literal notranslate"><span class="pre">processes</span></code> scheduler copies data for every task, while
<code class="docutils literal notranslate"><span class="pre">distributed</span></code> scheduler copies data for each worker.</p>
</div>
</div>
<div class="admonition-svd-with-large-skinny-matrix-using-distributed-scheduler exercise important admonition" id="exercise-1">
<p class="admonition-title">SVD with large skinny matrix using <code class="docutils literal notranslate"><span class="pre">distributed</span></code> scheduler</p>
<p>We can use dask to compute SVD of a large matrix which does not fit into the
memory of a normal laptop/desktop. While it is computing, you should switch to
the Dask dashboard and watch column “Workers” and “Graph”, so you must run this
using <code class="docutils literal notranslate"><span class="pre">distributed</span></code> scheduler</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">dask</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dask.array</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">da</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">2000000</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
<span class="n">X</span>
<span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
<span class="n">dask</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

</pre></div>
</div>
<p>SVD is only supported for arrays with chunking in one dimension, which requires that the matrix
is either <em>tall-and-skinny</em> or <em>short-and-fat</em>.
If chunking in both dimensions is needed, one should use approximate algorithm.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">dask</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">dask.array</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">da</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">),</span> <span class="n">chunks</span><span class="o">=</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">))</span>
<span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd_compressed</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">dask</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

</pre></div>
</div>
</div>
<div class="admonition-memory-management callout admonition" id="callout-0">
<p class="admonition-title">Memory management</p>
<p>You may observe that there are different memory categories showing on the dashboard:</p>
<ul class="simple">
<li><p>process: Overall memory used by the worker process, as measured by the OS</p></li>
<li><p>managed: Size of data that Dask holds in RAM, but most probably inaccurate, excluding spilled data.</p></li>
<li><p>unmanaged: Memory that Dask is not directly aware of, this can be e.g. Python modules,
temporary arrays, memory leasks, memory not yet free()’d by the Python memory manager to the OS</p></li>
<li><p>unmanaged recent: Unmanaged memory that has appeared within the last 30 seconds whch is not included
in the “unmanaged” memory measure</p></li>
<li><p>spilled: Memory spilled to disk</p></li>
</ul>
<p>The sum of managed + unmanaged + unmanaged recent is equal by definition to the process memory.</p>
<p>When the managed memory exceeds 60% of the memory limit (target threshold),
the worker will begin to dump the least recently used data to disk.
Above 70% of the target memory usage based on process memory measurment (spill threshold),
the worker will start dumping unused data to disk.</p>
<p>At 80% process memory load, currently executing tasks continue to run, but no additional tasks
in the worker’s queue will be started.</p>
<p>At 95% process memory load (terminate threshold), all workers will be terminated. Tasks will be cancelled
as well and data on the worker will be lost and need to be recomputed.</p>
</div>
</section>
</div>
<div class="toctree-wrapper compound">
<span id="document-quick-reference"></span><section id="quick-reference">
<h2>Quick Reference<a class="headerlink" href="#quick-reference" title="Link to this heading">¶</a></h2>
</section>
<span id="document-guide"></span><section id="instructor-s-guide">
<h2>Instructor’s guide<a class="headerlink" href="#instructor-s-guide" title="Link to this heading">¶</a></h2>
<section id="why-we-teach-this-lesson">
<h3>Why we teach this lesson<a class="headerlink" href="#why-we-teach-this-lesson" title="Link to this heading">¶</a></h3>
</section>
<section id="intended-learning-outcomes">
<h3>Intended learning outcomes<a class="headerlink" href="#intended-learning-outcomes" title="Link to this heading">¶</a></h3>
</section>
<section id="timing">
<h3>Timing<a class="headerlink" href="#timing" title="Link to this heading">¶</a></h3>
</section>
<section id="preparing-exercises">
<h3>Preparing exercises<a class="headerlink" href="#preparing-exercises" title="Link to this heading">¶</a></h3>
<p>e.g. what to do the day before to set up common repositories.</p>
</section>
<section id="other-practical-aspects">
<h3>Other practical aspects<a class="headerlink" href="#other-practical-aspects" title="Link to this heading">¶</a></h3>
</section>
<section id="interesting-questions-you-might-get">
<h3>Interesting questions you might get<a class="headerlink" href="#interesting-questions-you-might-get" title="Link to this heading">¶</a></h3>
</section>
<section id="typical-pitfalls">
<h3>Typical pitfalls<a class="headerlink" href="#typical-pitfalls" title="Link to this heading">¶</a></h3>
</section>
</section>
</div>
<section id="what-to-expect-from-this-course">
<h2>What to expect from this course<a class="headerlink" href="#what-to-expect-from-this-course" title="Link to this heading">¶</a></h2>
<div class="admonition-discussion discussion important admonition" id="discussion-0">
<p class="admonition-title">Discussion</p>
<p>How large are the datasets you are working with?</p>
</div>
<p>Both for classical machine/deep learning and (generative) AI, the amount of
data needed to train ever-growing models is becoming bigger and bigger.
Moreover, great strides in both hardware and software development for high
performance computing (HPC) applications allow for large scale computations
that were not possible before.
This course focuses on high performance data analytics (HPDA). The data
can come from simulations or experiments (or just generally available
datasets), and the goal is to pre-process, analyse and visualise it.
The lesson introduces some of the modern Python stack for data analytics,
dealing with packages such as Pandas, Polars, multithreading
and Dask, as well as Streamlit for large-scale data visualisations.</p>
</section>
<section id="learning-outcomes">
<h2>Learning outcomes<a class="headerlink" href="#learning-outcomes" title="Link to this heading">¶</a></h2>
<p>This lesson provides a broad overview of methods to work with large datasets
using tools and libraries from the Python ecosystem. Since this field is
fairly extensive, we will try to expose just enough details on each topic
for you to get a good idea of the picture and an understanding of what
combination of tools and libraries will work well for your particular use
case.</p>
<p>Specifically, this lesson covers:</p>
<ul class="simple">
<li><p>Tools for efficiently storing data and writing/reading it to/from disk</p></li>
<li><p>Interfacing with databases and object storage solutions</p></li>
<li><p>Main libraries to work with arrays and tabular data</p></li>
<li><p>Performance monitoring and benchmarking</p></li>
<li><p>Workload parallelisation: threads and Dask</p></li>
</ul>
</section>
<section id="see-also">
<h2>See also<a class="headerlink" href="#see-also" title="Link to this heading">¶</a></h2>
<div class="warning admonition">
<p class="admonition-title">Credit</p>
<p>Don’t forget to check out additional course materials from the
<a class="reference external" href="https://datacarpentry.org/lessons/">Data carpentry</a>, such as:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://datacarpentry.github.io/python-ecology-lesson/">Data Analysis and Visualization in Python for Ecologists</a></p></li>
<li><p><a class="reference external" href="https://pandas.pydata.org/pandas-docs/version/1.3/user_guide/10min.html#minutes-to-pandas">10 minutes to pandas</a></p></li>
<li><p><a class="reference external" href="https://tomaugspurger.net/posts/modern-1-intro/">Modern Pandas (blog series by Tom Augspurger)</a></p></li>
</ul>
<p>Moreover, the Polars <a class="reference external" href="https://docs.pola.rs/">documentation</a> and
<a class="reference external" href="https://github.com/r0f1/datascience">Awesome data science with Python</a>
are valuable resources, as well as
<a class="reference external" href="https://pythonspeed.com/datascience/#pandas">PythonSpeed</a>.</p>
</div>
<div class="attention admonition">
<p class="admonition-title">License</p>
<div class="attention dropdown admonition">
<p class="admonition-title">CC BY-SA for media and pedagogical material</p>
<p>Copyright © 2025 XXX. This material is released by XXX under the Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0).</p>
<p><strong>Canonical URL</strong>: <a class="reference external" href="https://creativecommons.org/licenses/by-sa/4.0/">https://creativecommons.org/licenses/by-sa/4.0/</a></p>
<p><a class="reference external" href="https://creativecommons.org/licenses/by-sa/4.0/legalcode.en">See the legal code</a></p>
<p class="rubric" id="you-are-free-to">You are free to</p>
<ol class="arabic simple">
<li><p><strong>Share</strong> — copy and redistribute the material in any medium or format for any purpose, even commercially.</p></li>
<li><p><strong>Adapt</strong> — remix, transform, and build upon the material for any purpose, even commercially.</p></li>
<li><p>The licensor cannot revoke these freedoms as long as you follow the license terms.</p></li>
</ol>
<p class="rubric" id="under-the-following-terms">Under the following terms</p>
<ol class="arabic simple">
<li><p><strong>Attribution</strong> — You must give <a class="reference external" href="https://creativecommons.org/licenses/by-sa/4.0/#ref-appropriate-credit">appropriate credit</a> , provide a link to the license, and <a class="reference external" href="https://creativecommons.org/licenses/by-sa/4.0/#ref-indicate-changes">indicate if changes were made</a> . You may do so in any reasonable manner, but not in any way that suggests the licensor endorses you or your use.</p></li>
<li><p><strong>ShareAlike</strong> — If you remix, transform, or build upon the material, you must distribute your contributions under the <a class="reference external" href="https://creativecommons.org/licenses/by-sa/4.0/#ref-same-license">same license</a> as the original.</p></li>
<li><p><strong>No additional restrictions</strong> — You may not apply legal terms or <a class="reference external" href="https://creativecommons.org/licenses/by-sa/4.0/#ref-technological-measures">technological measures</a> that legally restrict others from doing anything the license permits.</p></li>
</ol>
<p class="rubric" id="notices">Notices</p>
<p>You do not have to comply with the license for elements of the material in the public domain or where your use is permitted by an applicable <a class="reference external" href="https://creativecommons.org/licenses/by/4.0/deed.en#ref-exception-or-limitation">exception or limitation</a> .</p>
<p>No warranties are given. The license may not give you all of the permissions necessary for your intended use. For example, other rights such as <a class="reference external" href="https://creativecommons.org/licenses/by/4.0/deed.en#ref-publicity-privacy-or-moral-rights">publicity, privacy, or moral rights</a> may limit how you use the material.</p>
<p>This deed highlights only some of the key features and terms of the actual license. It is not a license and has no legal value. You should carefully review all of the terms and conditions of the actual license before using the licensed material.</p>
</div>
<div class="attention dropdown admonition">
<p class="admonition-title">MIT for source code and code snippets</p>
<p>MIT License</p>
<p>Copyright (c) 2025, ENCCS project, Francesco Fiusco, Qiang Li, Ashwin Mohanan, Juan Triviño, Yonglei Wang</p>
<p>Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the “Software”), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:</p>
<p>The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.</p>
<p>THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.</p>
</div>
</div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, ENCCS, Francesco Fiusco, Qiang Li, Ashwin Mohanan, Juan Triviño, Yonglei Wang
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/ENCCS/python-for-hpda" aria-label="GitHub">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <p class="caption" role="heading"><span class="caption-text">The lesson</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="#document-tabular-data">Tabular data (aka Dataframes)</a></li>
<li class="toctree-l1"><a class="reference internal" href="#document-interfacing-with-storage">Storage &amp; serialisation backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="#document-visualisation">Visualisations and dashboards</a></li>
<li class="toctree-l1"><a class="reference internal" href="#document-benchmarking">Benchmarking</a></li>
<li class="toctree-l1"><a class="reference internal" href="#document-multithreading">Multithreading</a></li>
<li class="toctree-l1"><a class="reference internal" href="#document-dask">Dask for Scalable Analytics</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Optional material</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="#document-dask_opt">Dask (II)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="#document-quick-reference">Quick Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="#document-guide">Instructor’s guide</a></li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=d6d90d09"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=46bd48cc"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=35a8b989"></script>
    <script src="_static/minipres.js?v=a0d29692"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/tabs.js?v=3030b3cb"></script>
    </body>
</html>